schedules:
- cron: "0 0 * * *"
  displayName: Daily build
  branches:
    include:
    - master
  always: true

pool:
  vmImage: 'Ubuntu-16.04'

variables:
  IMAGE_TAG_PREFIX: $[format('1.0.{0:HHm}', pipeline.startTime)]

steps:
- bash: docker login -u $ENV_CONTAINER_REGISTRY_USER_NAME -p  $ENV_CONTAINER_REGISTRY_PASSWORD $ENV_CONTAINER_REGISTRY_LOGIN_SERVER
  env:
    ENV_CONTAINER_REGISTRY_USER_NAME: $(CONTAINER_REGISTRY_USER_NAME)
    ENV_CONTAINER_REGISTRY_PASSWORD: $(CONTAINER_REGISTRY_PASSWORD)
    ENV_CONTAINER_REGISTRY_LOGIN_SERVER: $(CONTAINER_REGISTRY_LOGIN_SERVER)

- task: CopyFiles@2
  inputs:
    SourceFolder: $(Build.SourcesDirectory)
    contents: .git/**
    targetFolder: $(Build.SourcesDirectory)/scripts/datacontainer
- task: Docker@2
  displayName: Build
  inputs:
    command: build
    Dockerfile: scripts/datacontainer/Dockerfile
    containerRegistry: '***'
    repository: $(CONTAINER_REGISTRY_REPOSITORY_NAME)
    tags: |
      latest
      $(IMAGE_TAG_PREFIX)$(Build.BuildNumber)

- task: Docker@2
  displayName: Push
  inputs:
    containerRegistry: '***'
    repository: $(CONTAINER_REGISTRY_REPOSITORY_NAME)
    tags: |
      latest
      $(IMAGE_TAG_PREFIX)$(Build.BuildNumber)
