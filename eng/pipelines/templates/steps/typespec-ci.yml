parameters:
- name: Folder
  type: string
- name: DisplayName
  type: string

steps:
- script: |
    # Log commands before running
    set -x

    exit_code=0

    pushd ${{parameters.Folder}}

    if test -f package.json; then
      echo "TypeSpec folders MUST NOT contain a package.json, and instead MUST rely on the root package.json"
      exit_code=1
    fi

    # Pass "--no" to ensure npx does not install anything (TypeSpec compiler should already be installed)
    npx --no tsp compile . --warn-as-error || exit_code=1

    # Format parent folder to include shared files (disabled until formatting diffs are fixed)
    # npx tsp format ../**/*.tsp

    popd

    # If any files are added, changed, or deleted, print diff and return error
    if [ -n "$(git status --porcelain)" ]; then
      git status
      git diff
      exit_code=1
    fi

    # Revert any changes
    git restore .
    git clean -df

    exit $exit_code
  displayName: ${{parameters.DisplayName}}
  condition: succeededOrFailed()
