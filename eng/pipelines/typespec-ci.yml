trigger:
  branches:
    include:
    - main
    - typespec-next

pr:
  branches:
    include:
    - main
    - typespec-next
  paths:
    include:
    - package.json
    - package-lock.json
    - eng/pipelines/typespec-ci.yml
    - eng/pipelines/templates/steps/typespec-ci.yml
    - eng/tools/TypeSpecValidation
    - specification/contosowidgetmanager
    - specification/cognitiveservices
    - specification/confidentialledger
    - specification/containerservice
    - specification/containerstorage
    - specification/eventgrid
    - specification/servicenetworking
    - specification/sphere
    - specification/translation

jobs:
- job: TypeSpecCI
  pool:
    name: azsdk-pool-mms-ubuntu-2204-general
    vmImage: ubuntu-22.04

  steps:
  - script: npm ci
    displayName: npm ci

  - script: npm ls -a
    displayName: npm ls -a
    condition: succeededOrFailed()

  - script: npm run build
    displayName: npm run build
    condition: succeededOrFailed()
  - pwsh: |
      $typespecFolders = @()
      if ('$(Build.Reason)' -eq 'PullRequest') {
        $typespecFolders = $(Build.SourcesDirectory)/eng/scripts/Get-Typespec-Folders.ps1 $(Build.SourcesDirectory) "$(System.PullRequest.TargetBranch)" "$(System.PullRequest.SourceBranch)"
      }
      else {
        $typespecFolders = $(Build.SourcesDirectory)/eng/scripts/Get-Typespec-Folders.ps1 $(Build.SourcesDirectory)
      }

      $exitCode = 0
      foreach ($typeSpecFolder in $typeSpecFolders) {
        try {
          npx --no tsv $typeSpecFolder
        }
        catch {
          $exitCode = 1
        }
        git restore .
        git clean -df
      }

      exit $exitCode
    displayName: TypeSpecValidation
    condition: succeededOrFailed()
