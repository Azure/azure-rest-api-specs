trigger:
  branches:
    include:
    - main
    - typespec-next

pr: none

jobs:
- job: Validate_All_Specs

  strategy:
    matrix:
      Linux:
        Pool: azsdk-pool-mms-ubuntu-2204-general
        OsVmImage: ubuntu-22.04
      Windows:
        Pool: azsdk-pool-mms-win-2022-general
        OsVmImage: windows-2022

  pool:
    name: $(Pool)
    vmImage: $(OSVmImage)

  steps:
  - script: git -c user.name="azure-sdk" -c user.email="azuresdk@microsoft.com" merge origin/main
    displayName: git merge origin/main

  # Remove lockfile to update all packages to latest "next" version
  - script: rm package-lock.json
    displayName: rm package-lock.json

  - script: npm install
    displayName: npm install

  - script: npm ls -a
    displayName: npm ls -a
    condition: succeededOrFailed()

  - script: git restore package-lock.json
    displayName: Revert package-lock.json
    condition: succeededOrFailed()

  - pwsh: |
      $(Build.SourcesDirectory)/eng/scripts/Validate-TypeSpec.ps1 $(Build.SourcesDirectory) -GitClean
    displayName: Validate All Specs
    condition: succeededOrFailed()
