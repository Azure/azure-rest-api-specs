name: Create APIView

on:
  workflow_run:
    workflows: ["Generate APIView Artifact"]
    types:
      - completed

jobs:
  create-apiview:
    runs-on: ubuntu-latest

    steps:
    - name: Download Workflow Artifacts
      uses: actions/download-artifact@v4
      with:
        name: workflow-params
        path: ${{ github.workspace }}/artifacts/workflow-params
        github-token: ${{ github.token }}
        repository: ${{ github.repository }}
        run-id: ${{ github.event.workflow_run.id }}

    - name: Read JSON File
      id: read-json
      run: |
        PARAMS=$(cat ${{ github.workspace }}/artifacts/workflow-params/output-parameters.json)
        echo $PARAMS
        echo "APIViewArtifactsDirectoryName=$(echo $PARAMS | jq -r '.APIViewArtifactsDirectoryName')" >> $GITHUB_ENV
        echo "APIViewArtifactsName=$(echo $PARAMS | jq -r '.APIViewArtifactsName')" >> $GITHUB_ENV
        echo "APIViewAPIUri=$(echo $PARAMS | jq -r '.APIViewAPIUri')" >> $GITHUB_ENV
        echo "PullRequestRef=$(echo $PARAMS | jq -r '.PullRequestRef')" >> $GITHUB_ENV
        echo "PullRequestNumber=$(echo $PARAMS | jq -r '.PullRequestNumber')" >> $GITHUB_ENV

    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        ref: ${{ env.PullRequestRef }}
        fetch-depth: 0

    - name: Download Swagger APIView Artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.APIViewArtifactsName }}
        path: ${{ github.workspace }}/artifacts/${{ env.APIViewArtifactsDirectoryName }}
        github-token: ${{ github.token }}
        repository: ${{ github.repository }}
        run-id: ${{ github.event.workflow_run.id }}

    - name: Create Swagger APIView
      shell: pwsh
      run: |
        eng/scripts/Create-Swagger-APIView.ps1 `
          -ArtiFactsStagingDirectory ${{ github.workspace }}/artifacts `
          -APIViewArtifactsDirectoryName ${{ env.APIViewArtifactsDirectoryName }} `
          -APIViewArtifactsName ${{ env.APIViewArtifactsName }} `
          -APIViewUri ${{ env.APIViewAPIUri }} `
          -BuildId ${{ github.event.workflow_run.id }} `
          -RepoName ${{ github.repository }} `
          -PullRequestNumber ${{ env.PullRequestNumber }} `
          -Language 'Swagger' `
          -CommitSha ${{ github.event.workflow_run.head_sha }}