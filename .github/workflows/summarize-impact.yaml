name: "[TEST-IGNORE] Summarize PR Impact"

on: pull_request

permissions:
  contents: read
  pull-requests: read

jobs:
  impact:
    name: "[TEST-IGNORE] Summarize PR Impact"
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout eng
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            eng/
            .github/

      - name: Checkout 'after' state
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          path: after

      - name: Checkout 'before' state
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: before

      - name: Setup Node and install deps
        uses: ./.github/actions/setup-node-install-deps

      - name: Get PR labels
        id: get-labels
        run: |
          labels=$(gh pr view ${{ github.event.pull_request.number }} --json labels --jq '[.labels[].name] | join(",")')
          echo "labels=$labels" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Run Summarize Impact
        id: summarize-impact
        run: |
          npm exec --no -- summarize-impact --sourceDirectory after --targetDirectory before \
            --number "${{ github.event.pull_request.number }}" \
            --sb "${{ github.event.pull_request.head.ref }}" \
            --tb "${{ github.event.pull_request.base.ref }}" \
            --sha "${{ github.event.pull_request.head.sha }}" \
            --repo "${{ github.repository }}" \
            --owner "${{ github.repository_owner }}" \
            --labels "${{ steps.get-labels.outputs.labels }}" \
            --isDraft ${{ github.event.pull_request.draft }}
        env:
          # We absolutely need to avoid OOM errors due to certain inherited types from openapi-alps
          NODE_OPTIONS: "--max-old-space-size=8192"

      # Used by other workflows like set-status
      - name: Set job-summary artifact
        if: ${{ always() && steps.summarize-impact.outputs.summary }}
        uses: actions/upload-artifact@v4
        with:
          name: job-summary
          path: ${{ steps.summarize-impact.outputs.summary }}
          # If the file doesn't exist, just don't add the artifact
          if-no-files-found: ignore
