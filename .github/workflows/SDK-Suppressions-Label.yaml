name: SDK Suppression Label

on:
  pull_request:
    branches:
      - jacktn/suppression-action 
    types:
      - opened
      - synchronize
      - reopened

  workflow_dispatch:
  
jobs:
  process-sdk-suppressions-labels:
    name: Process Sup
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # outputs:
      # process-sdk-suppressions-output: ${{ steps.run-suppressions-script.outputs.suppressions-result-output }}
      # has-output: ${{ steps.run-suppressions-script.outputs.has-output }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Required since "HEAD^" is passed to Get-ChangedFiles
          fetch-depth: 2

      - name: Setup Node and run `npm ci`
        uses: ./.github/actions/setup-node-npm-ci

      - name: Get GitHub PullRequest Changed Files
        shell: pwsh
        id: get-changedFiles
        run: |
          . eng/scripts/ChangedFiles-Functions.ps1
          $changedFiles = @(Get-ChangedFiles)
          echo "PR Changed files: $changedFiles"
          echo "::set-output name=changedFiles::$changedFiles"

      - name: Get GitHub PullRequest Context
        uses: actions/github-script@v7
        id: fetch-pullRequest-context
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              throw new Error("This workflow must run in the context of a pull request.");
            }
            console.log("This action trigger by ", context.eventName);
            const prContext = {
              number: pr.number,
              title: pr.title,
              html_url: pr.html_url,
              labels: pr.labels.map(label => label.name)
            };
            return JSON.stringify(prContext);
          result-encoding: string

      - name: Run get suppressions label script
        id: run-suppressions-script
        env:
          GITHUB_PULL_REQUEST_CONTEXT: ${{ steps.fetch-pullRequest-context.outputs.result }}
          OUTPUT_FILE: "output.json"
          GITHUB_PULL_REQUEST_CHANGE_FILES: ${{ steps.get-changedFiles.outputs.changedFiles }}
        run: |
          node eng/tools/sdk-suppressions/cmd/sdk-suppressions-label.js
          OUTPUT=$(cat $OUTPUT_FILE)
          echo "Script output labels: $OUTPUT"
          echo "::set-output name=suppressions-result-output::$OUTPUT"
          
          has_output=$(node -e "const fs = require('fs'); const data = JSON.parse(fs.readFileSync('$OUTPUT_FILE', 'utf8')); console.log(data.length === 0 ? 'false' : 'true');")
          echo "Script has-output: $has_output"
          echo "::set-output name=has-output::$has_output"

          labelsToAdd=$(echo "$OUTPUT" | sed -n 's/.*"labelsToAdd":\[\([^]]*\)\].*/\1/p' | tr -d '" ')
          labelsToRemove=$(echo "$OUTPUT" | sed -n 's/.*"labelsToRemove":\[\([^]]*\)\].*/\1/p' | tr -d '" ')

          for label in $labelsToAdd; do
            echo "Label to add: $label"
            echo "::set-output name=has-$label::true"
            echo "::set-output name=$label::true"
          done

          for label in $labelsToRemove; do
            echo "Label to remove: $label"
            echo "::set-output name=has-$label::true"
            echo "::set-output name=$label::false"
          done
      
      - uses: ./.github/actions/add-label-artifact
        name: Upload artifact with results aaa
        if: ${{ steps.run-suppressions-script.outputs.has-aaa == 'true' }}
        with:
          name: "aaa"
          value: "${{ steps.run-suppressions-script.outputs.aaa }}"
          
      - uses: ./.github/actions/add-label-artifact
        name: Upload artifact with results bbb
        if: ${{ steps.run-suppressions-script.outputs.has-bbb == 'true' }}
        with:
          name: "bbb"
          value: "${{ steps.run-suppressions-script.outputs.bbb }}"

      - uses: ./.github/actions/add-label-artifact
        name: Upload artifact with results-go
        if: ${{ steps.run-suppressions-script.outputs.has-BreakingChange-Go-Sdk-Suppression == 'true' }}
        with:
          name: "BreakingChange-Go-Sdk-Suppression"
          value: "${{ steps.run-suppressions-script.outputs.BreakingChange-Go-Sdk-Suppression }}"
          
      - uses: ./.github/actions/add-label-artifact
        name: Upload artifact with results java
        if: ${{ steps.run-suppressions-script.outputs.has-BreakingChange-Java-Sdk-Suppression == 'true' }}
        with:
          name: "BreakingChange-Java-Sdk-Suppression"
          value: "${{ steps.run-suppressions-script.outputs.BreakingChange-Java-Sdk-Suppression }}"
          
      - uses: ./.github/actions/add-label-artifact
        name: Upload artifact with results js
        if: ${{ steps.run-suppressions-script.outputs.has-BreakingChange-JavaScript-Sdk-Suppression == 'true' }}
        with:
          name: "BreakingChange-JavaScript-Sdk-Suppression"
          value: "${{ steps.run-suppressions-script.outputs.BreakingChange-JavaScript-Sdk-Suppression }}"
          
      - uses: ./.github/actions/add-label-artifact
        name: Upload artifact with results python
        if: ${{ steps.run-suppressions-script.outputs.has-BreakingChange-Python-Sdk-Suppression == 'true' }}
        with:
          name: "BreakingChange-Python-Sdk-Suppression"
          value: "${{ steps.run-suppressions-script.outputs.BreakingChange-Python-Sdk-Suppression }}"

      

      # - name: Use outputs from previous step
      #   run: |
      #     echo "Labels to Add: ${{ steps.run-suppressions-script.outputs.labelsToAdd }}"
      #     echo "Labels to Remove: ${{ steps.run-suppressions-script.outputs.labelsToRemove }}"

      # - name: Upload artifact dependes on labels
      #   uses: ./.github/actions/add-multi-labels-artifact
      #   if: ${{ steps.run-suppressions-script.outputs.has-output == 'true' }}
      #   with:
      #     labels: ${{ steps.run-suppressions-script.outputs.suppressions-result-output }}
