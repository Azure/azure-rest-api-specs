name: azure-openapi-validator - Test

on:
  workflow_dispatch:
    inputs:
      ref:
        description: ref to test (eg refs/pull/1/merge)
        required: true
        default: main
        type: string

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: specs
          sparse-checkout: |
            .github

      - name: Checkout azure-openapi-validator@${{ inputs.ref }}
        uses: actions/checkout@v4
        with:
          repository: Azure/azure-openapi-validator
          ref: ${{ inputs.ref }}
          path: aov

      - name: Get azure-openapi-validator head SHA
        id: aov-vars
        run: echo "head-sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
        working-directory: aov

      - name: Cache azure-openapi-validator packages
        id: cache-aov
        uses: actions/cache@v4
        with:
          path: aov/packages/**/*.tgz
          key: aov-${{ steps.aov-vars.outputs.head-sha }}

      - name: Use Node 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Build azure-openapi-validator packages
        if: steps.cache-aov.outputs.cache-hit != 'true'
        run: |
          node common/scripts/install-run-rush.js install
          node common/scripts/install-run-rush.js build --verbose
          node common/scripts/install-run-rush.js pack
        working-directory: aov

      - name: List azure-openapi-validator packages
        run: find . -name *.tgz
        working-directory: aov/packages
