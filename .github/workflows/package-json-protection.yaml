name: package.json Protection

on:
  pull_request:
    branches:
      - main
      - package-json-protection

jobs:
  package-json-protection:
    name: package.json Protection

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        # Required since "HEAD^" is passed to Get-ChangedFiles
        fetch-depth: 2

    - name: Detect changes to package[-lock].json
      run: |
        . eng/scripts/ChangedFiles-Functions.ps1
        $changedFiles = @(Get-ChangedFiles -baseCommitish HEAD^ -targetCommitish HEAD -diffFilter "")
        if (($changedFiles -contains "package.json") -or ($changedFiles -contains "package-lock.json")) {
          Write-Output "::error::'package.json' and 'package-lock.json' should only be updated by the Azure SDK team.  If the changes are intentional, the PR may be merged by the Azure SDK team via bypassing the branch protections."
          exit 1
        }
        else {
          Write-Output "::notice::No changes to 'package.json' or 'package-lock.json'"
        }
      shell: pwsh
