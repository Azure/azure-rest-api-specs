import { Octokit } from "@octokit/rest";
import { strToU8, zipSync } from "fflate";
import { describe, expect, it } from "vitest";
import { execFile } from "../../../shared/src/exec.js";
import {
  createNextStepsComment,
  getCheckInfo,
  getCheckRunTuple,
  getExistingLabels,
  getImpactAssessment,
  updateLabels,
} from "../../src/summarize-checks/summarize-checks.js";
import { createMockCore, createMockGithub } from "../mocks.js";

const mockCore = createMockCore();
const WORKFLOW_URL = "http://github.com/a/fake/workflowrun/url";

/**
 * Find and extract the "Next Steps to Merge" existing comment on a PR.
 * Used in the integration test.
 */
async function getNextStepsComment(github, owner, repo, prNumber) {
  try {
    const { data: comments } = await github.rest.issues.listComments({
      owner: owner,
      repo: repo,
      issue_number: prNumber,
    });

    // Find comment containing "Next Steps to Merge"
    const nextStepsComment = comments.find((comment) =>
      comment.body.includes("<h2>Next Steps to Merge</h2>"),
    );

    return nextStepsComment ? nextStepsComment.body : null;
  } catch (error) {
    console.error(`Error getting comments for PR #${prNumber}:`, error.message);
    return null;
  }
}

describe("Summarize Checks Integration Tests", () => {
  describe("Repro a PR summarize-checks invocation", () => {
    it.skipIf(!process.env.GITHUB_TOKEN || !process.env.INTEGRATION_TEST)(
      "Should fetch real pr data and check the next steps to merge and final labels against what is actually there.",
      async () => {
        const issue_number = 24021;
        const owner = "Azure";
        const repo = "azure-rest-api-specs-pr";

        const ignorableLabels = [
          "VersioningReviewRequired",
          "BreakingChangeReviewRequired",
          "customer-reported",
          "dependencies",
          "javascript",
          "Monitor",
        ];

        const github = new Octokit({
          auth: process.env.GITHUB_TOKEN,
        });

        const { data: pr } = await github.rest.pulls.get({
          owner: owner,
          repo: repo,
          pull_number: issue_number,
        });

        // Get current PR labels and Next Steps comment
        const expectedNextStepsComment = await getNextStepsComment(
          github,
          owner,
          repo,
          issue_number,
        );

        const head_sha = "961faf0dd048e0b846026bc84fdd795f4b46e9e8";
        const expectedLabels = await getExistingLabels(github, owner, repo, issue_number);

        const [requiredCheckRuns, fyiCheckRuns, impactAssessment] = await getCheckRunTuple(
          github,
          mockCore,
          owner,
          repo,
          head_sha,
          issue_number,
          [],
        );

        let adjustedStartLabels = expectedLabels.filter((x) => ignorableLabels.includes(x));
        let labelContext = await updateLabels(adjustedStartLabels, impactAssessment);

        adjustedStartLabels = adjustedStartLabels.filter(
          (name) => !labelContext.toRemove.has(name),
        );
        for (const label of labelContext.toAdd) {
          if (!adjustedStartLabels.includes(label)) {
            adjustedStartLabels.push(label);
          }
        }

        const [commentBody, automatedChecksMet] = await createNextStepsComment(
          mockCore,
          repo,
          adjustedStartLabels,
          pr.base.ref,
          requiredCheckRuns,
          fyiCheckRuns,
          impactAssessment !== undefined,
          WORKFLOW_URL,
        );

        const actualLabels = [...labelContext.toAdd, ...labelContext.present];
        expect(actualLabels.sort()).toEqual(expectedLabels.sort());
        expect(commentBody).toEqual(expectedNextStepsComment);
        expect(automatedChecksMet).toBeTruthy();
      },
      600000,
    );
  });
});

describe("Summarize Checks Unit Tests", () => {
  describe("check result processing", () => {
    it("should generate success summary for no matched check suites (completed impactAssessment)", async () => {
      const repo = "azure-rest-api-specs";
      const targetBranch = "main";
      const labelNames = [];
      const fyiCheckRuns = [];
      const requiredCheckRuns = [];
      const expectedOutput = [
        '<h2>Next Steps to Merge</h2>✅ All automated merging requirements have been met! To get your PR merged, see <a href="https://aka.ms/azsdk/specreview/merge">aka.ms/azsdk/specreview/merge</a>.<br /><br />Comment generated by <a href="http://github.com/a/fake/workflowrun/url">summarize-checks</a> workflow run.',
        {
          name: "Automated merging requirements met",
          result: "SUCCESS",
          summary: `✅ All automated merging requirements have been met.<br/>To merge this PR, refer to <a href="https://aka.ms/azsdk/specreview/merge">aka.ms/azsdk/specreview/merge</a>.<br/>For help, consult comments on this PR and see [aka.ms/azsdk/pr-getting-help](https://aka.ms/azsdk/pr-getting-help).`,
        },
      ];

      const output = await createNextStepsComment(
        mockCore,
        repo,
        labelNames,
        targetBranch,
        requiredCheckRuns,
        fyiCheckRuns,
        true, // assessmentCompleted
        WORKFLOW_URL,
      );

      expect(output).toEqual(expectedOutput);
    });

    it("should generate success summary for all completed check suites", async () => {
      const repo = "azure-rest-api-specs";
      const targetBranch = "main";
      const labelNames = [];
      const fyiCheckRuns = [];
      const expectedOutput = [
        '<h2>Next Steps to Merge</h2>✅ All automated merging requirements have been met! To get your PR merged, see <a href="https://aka.ms/azsdk/specreview/merge">aka.ms/azsdk/specreview/merge</a>.<br /><br />Comment generated by <a href="http://github.com/a/fake/workflowrun/url">summarize-checks</a> workflow run.',
        {
          name: "Automated merging requirements met",
          result: "SUCCESS",
          summary: `✅ All automated merging requirements have been met.<br/>To merge this PR, refer to <a href="https://aka.ms/azsdk/specreview/merge">aka.ms/azsdk/specreview/merge</a>.<br/>For help, consult comments on this PR and see [aka.ms/azsdk/pr-getting-help](https://aka.ms/azsdk/pr-getting-help).`,
        },
      ];

      const requiredCheckRuns = [
        {
          name: "SpellCheck",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("SpellCheck"),
        },
        {
          name: "TypeSpec Requirement",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("TypeSpec Requirement"),
        },
        {
          name: "Protected Files",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Protected Files"),
        },
        {
          name: "TypeSpec Validation",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("TypeSpec Validation"),
        },
        {
          name: "Swagger BreakingChange",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger BreakingChange"),
        },
        {
          name: "Breaking Change(Cross-Version)",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Breaking Change(Cross-Version)"),
        },
        {
          name: "Swagger Avocado",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger Avocado"),
        },
        {
          name: "Swagger ModelValidation",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger ModelValidation"),
        },
        {
          name: "Swagger SemanticValidation",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger SemanticValidation"),
        },
        {
          name: "Swagger Lint(RPaaS)",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger Lint(RPaaS)"),
        },
        {
          name: "Automated merging requirements met",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Automated merging requirements met"),
        },
        {
          name: "license/cla",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("license/cla"),
        },
        {
          name: "Swagger PrettierCheck",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger PrettierCheck"),
        },
      ];

      const output = await createNextStepsComment(
        mockCore,
        repo,
        labelNames,
        targetBranch,
        requiredCheckRuns,
        fyiCheckRuns,
        true, // assessmentCompleted
        WORKFLOW_URL,
      );

      expect(output).toEqual(expectedOutput);
    });

    it("should generate success summary with completed required checks but in-progress FYI", async () => {
      const repo = "azure-rest-api-specs";
      const targetBranch = "main";
      const labelNames = [];
      const expectedOutput = [
        '<h2>Next Steps to Merge</h2>✅ All automated merging requirements have been met! To get your PR merged, see <a href="https://aka.ms/azsdk/specreview/merge">aka.ms/azsdk/specreview/merge</a>.<br /><br />Comment generated by <a href="http://github.com/a/fake/workflowrun/url">summarize-checks</a> workflow run.',
        {
          name: "Automated merging requirements met",
          result: "SUCCESS",
          summary: `✅ All automated merging requirements have been met.<br/>To merge this PR, refer to <a href="https://aka.ms/azsdk/specreview/merge">aka.ms/azsdk/specreview/merge</a>.<br/>For help, consult comments on this PR and see [aka.ms/azsdk/pr-getting-help](https://aka.ms/azsdk/pr-getting-help).`,
        },
      ];

      const requiredCheckRuns = [
        {
          name: "SpellCheck",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("SpellCheck"),
        },
        {
          name: "TypeSpec Requirement",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("TypeSpec Requirement"),
        },
      ];

      const fyiCheckRuns = [
        {
          name: "Swagger Avocado",
          status: "QUEUED",
          conclusion: null,
          checkInfo: {
            precedence: 1,
            name: "Swagger Avocado",
            suppressionLabels: [],
            troubleshootingGuide:
              "Refer to the check in the PR's 'Checks' tab for details on how to fix it and consult the <a href=\"https://aka.ms/ci-fix\">aka.ms/ci-fix</a> guide",
          },
        },
        {
          name: "license/cla",
          status: "IN_PROGRESS",
          conclusion: null,
          checkInfo: {
            precedence: 0,
            name: "license/cla",
            suppressionLabels: [],
            troubleshootingGuide:
              "Refer to the check in the PR's 'Checks' tab for details on how to fix it and consult the <a href=\"https://aka.ms/ci-fix\">aka.ms/ci-fix</a> guide",
          },
        },
      ];

      const output = await createNextStepsComment(
        mockCore,
        repo,
        labelNames,
        targetBranch,
        requiredCheckRuns,
        fyiCheckRuns,
        true, // assessmentCompleted
        WORKFLOW_URL,
      );

      expect(output).toEqual(expectedOutput);
    });

    // this case should NEVER occur in practice, due to Summarize PR Impact being made a "required" check, but in cases
    // where the user is targeting a branch that is not the main branch, we may have no required checks
    // but still have FYI checks in progress. This is a regression test to ensure we handle this case correctly.
    it("should generate success summary with 0 required checks but in-progress FYI", async () => {
      const repo = "azure-rest-api-specs";
      const targetBranch = "main";
      const labelNames = [];
      const expectedOutput = [
        '<h2>Next Steps to Merge</h2>✅ All automated merging requirements have been met! To get your PR merged, see <a href="https://aka.ms/azsdk/specreview/merge">aka.ms/azsdk/specreview/merge</a>.<br /><br />Comment generated by <a href="http://github.com/a/fake/workflowrun/url">summarize-checks</a> workflow run.',
        {
          name: "Automated merging requirements met",
          result: "SUCCESS",
          summary: `✅ All automated merging requirements have been met.<br/>To merge this PR, refer to <a href="https://aka.ms/azsdk/specreview/merge">aka.ms/azsdk/specreview/merge</a>.<br/>For help, consult comments on this PR and see [aka.ms/azsdk/pr-getting-help](https://aka.ms/azsdk/pr-getting-help).`,
        },
      ];

      const requiredCheckRuns = [];

      const fyiCheckRuns = [
        {
          name: "Swagger Avocado",
          status: "QUEUED",
          conclusion: null,
          checkInfo: {
            precedence: 1,
            name: "Swagger Avocado",
            suppressionLabels: [],
            troubleshootingGuide:
              "Refer to the check in the PR's 'Checks' tab for details on how to fix it and consult the <a href=\"https://aka.ms/ci-fix\">aka.ms/ci-fix</a> guide",
          },
        },
        {
          name: "license/cla",
          status: "IN_PROGRESS",
          conclusion: null,
          checkInfo: {
            precedence: 0,
            name: "license/cla",
            suppressionLabels: [],
            troubleshootingGuide:
              "Refer to the check in the PR's 'Checks' tab for details on how to fix it and consult the <a href=\"https://aka.ms/ci-fix\">aka.ms/ci-fix</a> guide",
          },
        },
      ];

      const output = await createNextStepsComment(
        mockCore,
        repo,
        labelNames,
        targetBranch,
        requiredCheckRuns,
        fyiCheckRuns,
        true, // assessmentCompleted
        WORKFLOW_URL,
      );

      expect(output).toEqual(expectedOutput);
    });

    it("should generate success with warning for error FYI", async () => {
      const repo = "azure-rest-api-specs";
      const targetBranch = "main";
      const labelNames = [];
      const expectedOutput = [
        `<h2>Next Steps to Merge</h2>Important checks have failed. As of today they are not blocking this PR, but in near future they may.<br/>Addressing the following failures is highly recommended:<br/><ul><li>⚠️ The check named <code>license/cla</code> has failed. Refer to the check in the PR's 'Checks' tab for details on how to fix it and consult the <a href="https://aka.ms/ci-fix">aka.ms/ci-fix</a> guide</li></ul>If you still want to proceed merging this PR without addressing the above failures, refer to step 4 in the <a href="https://aka.ms/azsdk/pr-diagram">PR workflow diagram</a>.<br /><br />Comment generated by <a href="http://github.com/a/fake/workflowrun/url">summarize-checks</a> workflow run.`,
        {
          name: "Automated merging requirements met",
          result: "SUCCESS",
          summary: `⚠️ Some important automated merging requirements have failed. As of today you can still merge this PR, but soon these requirements will be blocking.<br/>See <code>Next Steps to merge</code> comment on this PR for details on how to address them.<br/>If you want to proceed with merging this PR without fixing them, refer to <a href="https://aka.ms/azsdk/specreview/merge">aka.ms/azsdk/specreview/merge</a>.`,
        },
      ];
      const requiredCheckRuns = [
        {
          name: "SpellCheck",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("SpellCheck"),
        },
      ];

      const fyiCheckRuns = [
        {
          name: "license/cla",
          status: "COMPLETED",
          conclusion: "FAILURE",
          checkInfo: getCheckInfo("license/cla"),
        },
      ];

      const output = await createNextStepsComment(
        mockCore,
        repo,
        labelNames,
        targetBranch,
        requiredCheckRuns,
        fyiCheckRuns,
        true, // assessmentCompleted
        WORKFLOW_URL,
      );

      expect(output).toEqual(expectedOutput);
    });

    it("should generate pending summary when checks are partially in progress", async () => {
      const repo = "azure-rest-api-specs";
      const targetBranch = "main";
      const labelNames = [];
      const fyiCheckRuns = [];
      const expectedOutput = [
        `<h2>Next Steps to Merge</h2>⌛ Please wait. Next steps to merge this PR are being evaluated by automation. ⌛<br /><br />Comment generated by <a href="http://github.com/a/fake/workflowrun/url">summarize-checks</a> workflow run.`,
        {
          name: "Automated merging requirements met",
          result: "pending",
          summary: "The requirements for merging this PR are still being evaluated. Please wait.",
        },
      ];

      const requiredCheckRuns = [
        {
          name: "TypeSpec Validation",
          status: "IN_PROGRESS",
          conclusion: null,
          checkInfo: getCheckInfo("TypeSpec Validation"),
        },
        {
          name: "Swagger Avocado",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger Avocado"),
        },
        {
          name: "license/cla",
          status: "IN_PROGRESS",
          conclusion: null,
          checkInfo: getCheckInfo("license/cla"),
        },
      ];

      const output = await createNextStepsComment(
        mockCore,
        repo,
        labelNames,
        targetBranch,
        requiredCheckRuns,
        fyiCheckRuns,
        true, // assessmentCompleted
        WORKFLOW_URL,
      );

      expect(output).toEqual(expectedOutput);
    });

    it("should generate pending summary when checks are in progress", async () => {
      const repo = "azure-rest-api-specs";
      const targetBranch = "main";
      const labelNames = [];
      const fyiCheckRuns = [];
      const expectedOutput = [
        `<h2>Next Steps to Merge</h2>⌛ Please wait. Next steps to merge this PR are being evaluated by automation. ⌛<br /><br />Comment generated by <a href="http://github.com/a/fake/workflowrun/url">summarize-checks</a> workflow run.`,
        {
          name: "Automated merging requirements met",
          result: "pending",
          summary: "The requirements for merging this PR are still being evaluated. Please wait.",
        },
      ];

      const requiredCheckRuns = [
        {
          name: "TypeSpec Validation",
          status: "IN_PROGRESS",
          conclusion: null,
          checkInfo: getCheckInfo("TypeSpec Validation"),
        },
        {
          name: "Swagger Avocado",
          status: "QUEUED",
          conclusion: null,
          checkInfo: getCheckInfo("Swagger Avocado"),
        },
        {
          name: "license/cla",
          status: "IN_PROGRESS",
          conclusion: null,
          checkInfo: getCheckInfo("license/cla"),
        },
      ];

      const output = await createNextStepsComment(
        mockCore,
        repo,
        labelNames,
        targetBranch,
        requiredCheckRuns,
        fyiCheckRuns,
        true, // assessmentCompleted
        WORKFLOW_URL,
      );

      expect(output).toEqual(expectedOutput);
    });

    it("should generate pending summary when impact assessment is not completed", async () => {
      const repo = "azure-rest-api-specs";
      const targetBranch = "main";
      const labelNames = [];
      const fyiCheckRuns = [];
      const expectedOutput = [
        `<h2>Next Steps to Merge</h2>⌛ Please wait. Next steps to merge this PR are being evaluated by automation. ⌛<br /><br />Comment generated by <a href="${WORKFLOW_URL}">summarize-checks</a> workflow run.`,
        {
          name: "Automated merging requirements met",
          result: "pending",
          summary: "The requirements for merging this PR are still being evaluated. Please wait.",
        },
      ];

      const requiredCheckRuns = [
        {
          name: "SpellCheck",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("SpellCheck"),
        },
        {
          name: "TypeSpec Requirement",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("TypeSpec Requirement"),
        },
        {
          name: "Protected Files",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Protected Files"),
        },
        {
          name: "TypeSpec Validation",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("TypeSpec Validation"),
        },
        {
          name: "Swagger BreakingChange",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger BreakingChange"),
        },
        {
          name: "Breaking Change(Cross-Version)",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Breaking Change(Cross-Version)"),
        },
        {
          name: "Swagger Avocado",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger Avocado"),
        },
        {
          name: "Swagger ModelValidation",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger ModelValidation"),
        },
        {
          name: "Swagger SemanticValidation",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger SemanticValidation"),
        },
        {
          name: "Swagger Lint(RPaaS)",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger Lint(RPaaS)"),
        },
        {
          name: "Automated merging requirements met",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Automated merging requirements met"),
        },
        {
          name: "license/cla",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("license/cla"),
        },
        {
          name: "Swagger PrettierCheck",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger PrettierCheck"),
        },
      ];

      const output = await createNextStepsComment(
        mockCore,
        repo,
        labelNames,
        targetBranch,
        requiredCheckRuns,
        fyiCheckRuns,
        false, // assessmentCompleted
        WORKFLOW_URL,
      );

      expect(output).toEqual(expectedOutput);
    });

    it("should generate pending summary when checks are in progress", async () => {
      const repo = "azure-rest-api-specs";
      const targetBranch = "main";
      const labelNames = [];
      const fyiCheckRuns = [];
      const expectedOutput = [
        `<h2>Next Steps to Merge</h2>⌛ Please wait. Next steps to merge this PR are being evaluated by automation. ⌛<br /><br />Comment generated by <a href="http://github.com/a/fake/workflowrun/url">summarize-checks</a> workflow run.`,
        {
          name: "Automated merging requirements met",
          result: "pending",
          summary: "The requirements for merging this PR are still being evaluated. Please wait.",
        },
      ];

      const requiredCheckRuns = [
        {
          name: "TypeSpec Validation",
          status: "IN_PROGRESS",
          conclusion: null,
          checkInfo: {
            precedence: 0,
            name: "TypeSpec Validation",
            suppressionLabels: [],
            troubleshootingGuide:
              "Refer to the check in the PR's 'Checks' tab for details on how to fix it and consult the <a href=\"https://aka.ms/ci-fix\">aka.ms/ci-fix</a> guide",
          },
        },
        {
          name: "Swagger Avocado",
          status: "QUEUED",
          conclusion: null,
          checkInfo: {
            precedence: 1,
            name: "Swagger Avocado",
            suppressionLabels: [],
            troubleshootingGuide:
              "Refer to the check in the PR's 'Checks' tab for details on how to fix it and consult the <a href=\"https://aka.ms/ci-fix\">aka.ms/ci-fix</a> guide",
          },
        },
        {
          name: "license/cla",
          status: "IN_PROGRESS",
          conclusion: null,
          checkInfo: {
            precedence: 0,
            name: "license/cla",
            suppressionLabels: [],
            troubleshootingGuide:
              "Refer to the check in the PR's 'Checks' tab for details on how to fix it and consult the <a href=\"https://aka.ms/ci-fix\">aka.ms/ci-fix</a> guide",
          },
        },
      ];

      const output = await createNextStepsComment(
        mockCore,
        repo,
        labelNames,
        targetBranch,
        requiredCheckRuns,
        fyiCheckRuns,
        true, // assessmentCompleted
        WORKFLOW_URL,
      );

      expect(output).toEqual(expectedOutput);
    });

    it("should generate pending summary when checks there are no required checks blocking or completed, but successful FYI checks", async () => {
      const repo = "azure-rest-api-specs";
      const targetBranch = "main";
      const labelNames = [
        "ARMReview",
        "ARMAutoSignedOff",
        "resource-manager",
        "TypeSpec",
        "RPaaS",
        "ARMSignedOff",
        "PublishToCustomers",
      ];
      const expectedOutput = [
        `<h2>Next Steps to Merge</h2>Important checks have failed. As of today they are not blocking this PR, but in near future they may.<br/>Addressing the following failures is highly recommended:<br/><ul><li>⚠️ The check named <code>Swagger LintDiff</code> has failed. Refer to the check in the PR's 'Checks' tab for details on how to fix it and consult the <a href="https://aka.ms/ci-fix">aka.ms/ci-fix</a> guide</li></ul><br /><br />Comment generated by <a href="http://github.com/a/fake/workflowrun/url">summarize-checks</a> workflow run.`,
        {
          name: "Automated merging requirements met",
          result: "pending",
          summary: "The requirements for merging this PR are still being evaluated. Please wait.",
        },
      ];

      const fyiCheckRuns = [
        {
          name: "Swagger BreakingChange",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger BreakingChange"),
        },
        {
          name: "Swagger LintDiff",
          status: "COMPLETED",
          conclusion: "FAILURE",
          checkInfo: getCheckInfo("Swagger LintDiff"),
        },
      ];

      const requiredCheckRuns = [
        {
          name: "Summarize PR Impact",
          status: "IN_PROGRESS",
          conclusion: null,
          checkInfo: getCheckInfo("Summarize PR Impact"),
        },
      ];

      const output = await createNextStepsComment(
        mockCore,
        repo,
        labelNames,
        targetBranch,
        requiredCheckRuns,
        fyiCheckRuns,
        false, // assessmentCompleted
        WORKFLOW_URL,
      );

      expect(output).toEqual(expectedOutput);
    });

    it("Should generate error summary for a PR scenario where NotReadyForARMReview is present", async () => {
      const repo = "azure-rest-api-specs-pr";
      const targetBranch = "RPSaaSMaster";
      const labelNames = [
        "ARMReview",
        "NotReadyForARMReview",
        "PipelineBotTrigger",
        "PublishToCustomers",
        "resource-manager",
        "RPaaS",
        "TypeSpec",
        "VersioningReviewRequired",
      ];
      const fyiCheckRuns = [];
      const expectedComment =
        `<h2>Next Steps to Merge</h2>Next steps that must be taken to merge this PR: <br/><ul><li>❌ ` +
        `This PR is in purview of the ARM review (label: <code>ARMReview</code>). This PR must get <code>ARMSignedOff</code> label ` +
        `from an ARM reviewer.<br/>This PR is not ready for ARM review (label: <code>NotReadyForARMReview</code>). This PR will not ` +
        `be reviewed by ARM until relevant problems are fixed. Consult the rest of this <code>Next Steps to Merge</code> comment ` +
        `for details.<br/>Once the blocking problems are addressed, add to the PR a comment with contents <code>/azp run</code>. ` +
        `Automation will re-evaluate this PR and if everything looks good, it will add <code>WaitForARMFeedback</code> label which ` +
        `will put this PR on the ARM review queue.<br/>For details of the ARM review, see <a href="https://aka.ms/azsdk/pr-arm-review">` +
        `aka.ms/azsdk/pr-arm-review</a><br/></li><li>❌ This PR is <code>NotReadyForARMReview</code> because it has the <code>VersioningReviewRequired</code> ` +
        `label.<br/></li><li>❌ This PR has at least one change violating Azure versioning policy ` +
        `(label: <code>VersioningReviewRequired</code>).<br/>To unblock this PR, either a) introduce a new API version with these ` +
        `changes instead of modifying an existing API version, or b) follow the process at <a href="https://aka.ms/brch">aka.ms/brch</a>.</li>` +
        `<li>❌ The required check named <code>Swagger BreakingChange</code> has failed. To unblock this PR, follow the process at <a href="https://aka.ms/brch">` +
        `aka.ms/brch</a>.</li></ul><br /><br />Comment generated by <a href="http://github.com/a/fake/workflowrun/url">summarize-checks</a> workflow run.`;

      const expectedOutput = [
        expectedComment,
        {
          name: "Automated merging requirements met",
          result: "FAILURE",
          summary:
            "❌ This PR cannot be merged because some requirements are not met. See the details.",
        },
      ];

      const requiredCheckRuns = [
        {
          name: "license/cla",
          status: "QUEUED",
          conclusion: null,
          checkInfo: getCheckInfo("license/cla"),
        },
        {
          name: "Swagger PrettierCheck",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger PrettierCheck"),
        },
        {
          name: "TypeSpec Validation",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("TypeSpec Validation"),
        },
        {
          name: "Swagger SemanticValidation",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger SemanticValidation"),
        },
        {
          name: "TypeSpec Requirement",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("TypeSpec Requirement"),
        },
        {
          name: "Protected Files",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Protected Files"),
        },
        {
          name: "SpellCheck",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("SpellCheck"),
        },
        {
          name: "Swagger ModelValidation",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger ModelValidation"),
        },
        {
          name: "SDK Validation Status",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("SDK Validation Status"),
        },
        {
          name: "Breaking Change(Cross-Version)",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Breaking Change(Cross-Version)"),
        },
        {
          name: "Swagger BreakingChange",
          status: "COMPLETED",
          conclusion: "FAILURE",
          checkInfo: getCheckInfo("Swagger BreakingChange"),
        },
        {
          name: "Swagger Avocado",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger Avocado"),
        },
        {
          name: "Swagger LintDiff",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger LintDiff"),
        },
      ];

      const output = await createNextStepsComment(
        mockCore,
        repo,
        labelNames,
        targetBranch,
        requiredCheckRuns,
        fyiCheckRuns,
        true, // assessmentCompleted
        WORKFLOW_URL,
      );

      expect(output).toEqual(expectedOutput);
    });

    it("Should generate error summary for a PR scenario with labeling issues", async () => {
      const repo = "azure-rest-api-specs";
      const targetBranch = "main";
      const labelNames = [
        "Cognitive Services",
        "data-plane",
        "TypeSpec",
        "VersioningReviewRequired",
      ];
      const fyiCheckRuns = [];
      const expectedComment =
        "<h2>Next Steps to Merge</h2>Next steps that must be taken to merge this PR: <br/><ul>" +
        "<li>❌ This PR targets either the <code>main</code> branch of the public specs repo or the <code>RPSaaSMaster</code> branch of the private specs repo. " +
        "These branches are not intended for iterative development. Therefore, you must acknowledge you understand that after this PR is merged, the APIs are considered " +
        "shipped to Azure customers. Any further attempts at in-place modifications to the APIs will be subject to Azure's versioning " +
        "and breaking change policies. <b>Additionally, for control plane APIs, you must acknowledge that you are following all " +
        'the best practices documented by ARM at <a href="https://aka.ms/armapibestpractices">aka.ms/armapibestpractices</a>.</b> ' +
        "If you do intend to release the APIs to your customers by merging this PR, add the <code>PublishToCustomers</code> label " +
        "to your PR in acknowledgement of the above. Otherwise, retarget this PR onto a feature branch, i.e. with prefix <code>release-</code> " +
        '(see <a href="https://aka.ms/azsdk/api-versions#release--branches">aka.ms/azsdk/api-versions#release--branches</a>).</li>' +
        "<li>❌ This PR has at least one change violating Azure versioning policy (label: <code>VersioningReviewRequired</code>).<br/>To unblock this PR, either a) " +
        'introduce a new API version with these changes instead of modifying an existing API version, or b) follow the process at <a href="https://aka.ms/brch">aka.ms/brch</a>.' +
        "</li><li>❌ The required check named <code>TypeSpec Validation</code> has failed. Refer to the check in the PR's 'Checks' tab for details on how to fix it and consult " +
        'the <a href="https://aka.ms/ci-fix">aka.ms/ci-fix</a> guide</li></ul><br /><br />Comment generated by <a href="http://github.com/a/fake/workflowrun/url">summarize-checks</a> workflow run.';
      const expectedOutput = [
        expectedComment,
        {
          name: "Automated merging requirements met",
          result: "FAILURE",
          summary:
            "❌ This PR cannot be merged because some requirements are not met. See the details.",
        },
      ];

      const requiredCheckRuns = [
        {
          name: "SpellCheck",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("SpellCheck"),
        },
        {
          name: "TypeSpec Requirement",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("TypeSpec Requirement"),
        },
        {
          name: "Protected Files",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Protected Files"),
        },
        {
          name: "TypeSpec Validation",
          status: "COMPLETED",
          conclusion: "FAILURE",
          checkInfo: getCheckInfo("TypeSpec Validation"),
        },
        {
          name: "Swagger BreakingChange",
          status: "COMPLETED",
          conclusion: "FAILURE",
          checkInfo: getCheckInfo("Swagger BreakingChange"),
        },
        {
          name: "Breaking Change(Cross-Version)",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Breaking Change(Cross-Version)"),
        },
        {
          name: "Swagger Avocado",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger Avocado"),
        },
        {
          name: "Swagger ModelValidation",
          status: "COMPLETED",
          conclusion: "FAILURE",
          checkInfo: getCheckInfo("Swagger ModelValidation"),
        },
        {
          name: "Swagger SemanticValidation",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger SemanticValidation"),
        },
        {
          name: "Swagger Lint(RPaaS)",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger Lint(RPaaS)"),
        },
        {
          name: "Automated merging requirements met",
          status: "COMPLETED",
          conclusion: "FAILURE",
          checkInfo: getCheckInfo("Automated merging requirements met"),
        },
        {
          name: "license/cla",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("license/cla"),
        },
        {
          name: "Swagger PrettierCheck",
          status: "COMPLETED",
          conclusion: "SUCCESS",
          checkInfo: getCheckInfo("Swagger PrettierCheck"),
        },
      ];

      const output = await createNextStepsComment(
        mockCore,
        repo,
        labelNames,
        targetBranch,
        requiredCheckRuns,
        fyiCheckRuns,
        true, // assessmentCompleted
        WORKFLOW_URL,
      );

      expect(output).toEqual(expectedOutput);
    });

    it("should generate error summary with a failed required check, and failed FYI checks", async () => {
      const repo = "azure-rest-api-specs";
      const targetBranch = "main";
      const labelNames = [];
      const expectedCheckOutput = {
        name: "Automated merging requirements met",
        result: "FAILURE",
        summary:
          "❌ This PR cannot be merged because some requirements are not met. See the details.",
      };
      const expectedCommentOutput = `<h2>Next Steps to Merge</h2>Next steps that must be taken to merge this PR: <br/><ul><li>❌ The required check named <code>Swagger BreakingChange</code> has failed. To unblock this PR, follow the process at <a href="https://aka.ms/brch">aka.ms/brch</a>.</li></ul><br/>Important checks have failed. As of today they are not blocking this PR, but in near future they may.<br/>Addressing the following failures is highly recommended:<br/><ul><li>⚠️ The check named <code>TypeSpec Validation</code> has failed. Refer to the check in the PR's 'Checks' tab for details on how to fix it and consult the <a href="https://aka.ms/ci-fix">aka.ms/ci-fix</a> guide</li></ul><br /><br />Comment generated by <a href="http://github.com/a/fake/workflowrun/url">summarize-checks</a> workflow run.`;

      const fyiCheckRuns = [
        {
          name: "TypeSpec Validation",
          status: "COMPLETED",
          conclusion: "FAILURE",
          checkInfo: getCheckInfo("TypeSpec Validation"),
        },
      ];

      const requiredCheckRuns = [
        {
          name: "Swagger BreakingChange",
          status: "COMPLETED",
          conclusion: "FAILURE",
          checkInfo: getCheckInfo("Swagger BreakingChange"),
        },
      ];

      const [commentOutput, automatedCheckOutput] = await createNextStepsComment(
        mockCore,
        repo,
        labelNames,
        targetBranch,
        requiredCheckRuns,
        fyiCheckRuns,
        true, // assessmentCompleted
        WORKFLOW_URL,
      );

      expect(automatedCheckOutput).toEqual(expectedCheckOutput);
      expect(commentOutput).toEqual(expectedCommentOutput);
    });

    it("should generate error summary with a failed required check, and in-progress FYI checks", async () => {
      const repo = "azure-rest-api-specs";
      const targetBranch = "main";
      const labelNames = [];
      const expectedCheckOutput = {
        name: "Automated merging requirements met",
        result: "FAILURE",
        summary:
          "❌ This PR cannot be merged because some requirements are not met. See the details.",
      };

      const fyiCheckRuns = [
        {
          name: "TypeSpec Validation",
          status: "IN_PROGRESS",
          conclusion: null,
          checkInfo: getCheckInfo("TypeSpec Validation"),
        },
      ];

      const requiredCheckRuns = [
        {
          name: "Swagger BreakingChange",
          status: "COMPLETED",
          conclusion: "FAILURE",
          checkInfo: getCheckInfo("Swagger BreakingChange"),
        },
      ];

      const [, automatedCheckOutput] = await createNextStepsComment(
        mockCore,
        repo,
        labelNames,
        targetBranch,
        requiredCheckRuns,
        fyiCheckRuns,
        true, // assessmentCompleted
      );

      expect(automatedCheckOutput).toEqual(expectedCheckOutput);
    });

    it("should generate error summary when checks are in error state", async () => {
      const repo = "azure-rest-api-specs";
      const targetBranch = "main";
      const labelNames = [];
      const fyiCheckRuns = [];
      const expectedCheckOutput = {
        name: "Automated merging requirements met",
        result: "FAILURE",
        summary:
          "❌ This PR cannot be merged because some requirements are not met. See the details.",
      };

      const requiredCheckRuns = [
        {
          name: "Swagger BreakingChange",
          status: "COMPLETED",
          conclusion: "FAILURE",
          checkInfo: getCheckInfo("Swagger BreakingChange"),
        },
      ];

      const [, automatedCheckOutput] = await createNextStepsComment(
        mockCore,
        repo,
        labelNames,
        targetBranch,
        requiredCheckRuns,
        fyiCheckRuns,
        true, // assessmentCompleted
      );

      expect(automatedCheckOutput).toEqual(expectedCheckOutput);
    });
  });

  describe("getImpactAssessment", async () => {
    const unzipExists = await execFile("unzip")
      .then(() => true)
      .catch(() => false);

    // Runtime code currently requires "unzip" executable to exist
    it.runIf(unzipExists)("unzips and extracts artifact", async () => {
      /** @type {import("../../src/summarize-checks/labelling.js").ImpactAssessment} */
      const impactAssessment = {
        // Set booleans arbitrarily to false|true
        resourceManagerRequired: false,
        dataPlaneRequired: true,
        suppressionReviewRequired: false,
        isNewApiVersion: true,
        rpaasExceptionRequired: false,
        rpaasRpNotInPrivateRepo: true,
        rpaasChange: false,
        newRP: true,
        rpaasRPMissing: false,
        typeSpecChanged: true,
        isDraft: false,
        targetBranch: "test-target-branch",
      };

      const zip = zipSync({
        "summary.json": strToU8(JSON.stringify(impactAssessment)),
      });

      const github = createMockGithub();

      github.rest.actions.downloadArtifact.mockResolvedValue({
        data: Buffer.from(zip),
      });

      github.rest.actions.listWorkflowRunArtifacts.mockResolvedValue({
        data: {
          artifacts: [{ id: 1, name: "job-summary" }],
        },
      });

      await expect(
        getImpactAssessment(github, mockCore, "test-owner", "test-repo", 123),
      ).resolves.toEqual(impactAssessment);

      expect(github.rest.actions.downloadArtifact).toHaveBeenCalledWith({
        owner: "test-owner",
        repo: "test-repo",
        artifact_id: 1,
        archive_format: "zip",
      });

      github.rest.actions.listWorkflowRunArtifacts.mockResolvedValue({
        data: {
          artifacts: [
            { id: 1, name: "job-summary" /* updated_at: "1970" (default) */ },
            { id: 2, name: "job-summary", updated_at: "2025" },
            { id: 3, name: "job-summary", updated_at: "2024" },
          ],
        },
      });

      await expect(
        getImpactAssessment(github, mockCore, "test-owner", "test-repo", 123),
      ).resolves.toEqual(impactAssessment);

      expect(github.rest.actions.downloadArtifact).toHaveBeenCalledWith({
        owner: "test-owner",
        repo: "test-repo",
        artifact_id: 2,
        archive_format: "zip",
      });
    });

    it("throws if no job-summary artifact", async () => {
      const github = createMockGithub();

      await expect(
        getImpactAssessment(github, mockCore, "test-owner", "test-repo", 123),
      ).rejects.toThrowErrorMatchingInlineSnapshot(
        `[Error: Unable to find job-summary artifact for run ID: 123. This should never happen, as this section of code should only run with a valid runId.]`,
      );
    });
  });
});
