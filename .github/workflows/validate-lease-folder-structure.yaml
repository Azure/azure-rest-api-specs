name: Validate Lease Folder Structure

on:
  pull_request:
    types:
      # default
      - opened
      - synchronize
      - reopened
      # re-run if base branch is changed, since previous merge commit may generate incorrect diff
      - edited

permissions:
  contents: read

jobs:
  validate-folder-structure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Validate lease files
        run: |
          echo "========================================="
          echo "Running Lease File Validation"
          echo "========================================="
          EXIT_CODE=0
          TODAY=$(date +%Y-%m-%d)
          
          # Get all changed files in the lease/ directory
          ALL_LEASE_FILES=$(git diff --name-only origin/${{ github.base_ref }} HEAD | grep '^lease/' || true)
          
          if [ -z "$ALL_LEASE_FILES" ]; then
            echo "No lease files to validate"
            exit 0
          fi
          
          echo ""
          echo "Changed files in lease/ directory:"
          echo "$ALL_LEASE_FILES"
          echo ""
          
          # Validation 1: Check folder structure
          echo "========================================="
          echo "1. Validating Folder Structure"
          echo "========================================="
          
          INVALID_STRUCTURE=$(echo "$ALL_LEASE_FILES" | grep -vE '^lease/[A-Za-z0-9_.-]+/[A-Za-z0-9_.-]+/lease\.yaml$' || true)
          
          if [ -n "$INVALID_STRUCTURE" ]; then
            echo "❌ Invalid folder structure detected!"
            echo ""
            echo "Invalid files:"
            echo "$INVALID_STRUCTURE"
            echo ""
            echo "Expected format: lease/<Namespace>/<Service>/lease.yaml"
            echo "Examples:"
            echo "  - lease/Microsoft.Widget/Widget/lease.yaml"
            echo "  - lease/Azure.Storage/BlobService/lease.yaml"
            echo ""
            EXIT_CODE=1
          else
            echo "✅ All files follow the correct folder structure"
          fi
          
          # Get only valid lease.yaml files for content validation
          VALID_LEASE_FILES=$(echo "$ALL_LEASE_FILES" | grep -E '^lease/[A-Za-z0-9_.-]+/[A-Za-z0-9_.-]+/lease\.yaml$' || true)
          
          if [ -z "$VALID_LEASE_FILES" ]; then
            echo ""
            echo "No valid lease.yaml files to validate content"
            exit $EXIT_CODE
          fi
          
          # Validation 2-4: Check lease.yaml content
          echo ""
          echo "========================================="
          echo "2. Validating Lease File Contents"
          echo "========================================="
          
          for LEASE_FILE in $VALID_LEASE_FILES; do
            echo ""
            echo "File: $LEASE_FILE"
            echo "-----------------------------------------"
            
            # Extract folder structure components
            FOLDER_RP=$(echo "$LEASE_FILE" | cut -d'/' -f2)
            
            # Read lease.yaml fields
            RP_NAME=$(yq eval '.lease.resource-provider' "$LEASE_FILE" 2>/dev/null || echo "")
            STARTDATE=$(yq eval '.lease.startdate' "$LEASE_FILE" 2>/dev/null || echo "")
            REVIEWER=$(yq eval '.lease.reviewer' "$LEASE_FILE" 2>/dev/null || echo "")
            
            # Check: Resource provider name matches folder name
            if [ "$RP_NAME" != "$FOLDER_RP" ]; then
              echo "❌ Resource provider name mismatch!"
              echo "   Folder name: $FOLDER_RP"
              echo "   lease.yaml resource-provider: $RP_NAME"
              echo "   These must match exactly."
              EXIT_CODE=1
            else
              echo "✅ Resource provider name matches folder structure"
            fi
            
            # Check: Startdate format (ISO 8601: YYYY-MM-DD)
            if ! echo "$STARTDATE" | grep -qE '^[0-9]{4}-[0-9]{2}-[0-9]{2}$'; then
              echo "❌ Invalid startdate format!"
              echo "   Current: $STARTDATE"
              echo "   Expected: ISO 8601 format (YYYY-MM-DD)"
              EXIT_CODE=1
            else
              echo "✅ Startdate follows ISO 8601 format"
              
              # Check: Startdate is today or future (not past)
              if [[ "$STARTDATE" < "$TODAY" ]]; then
                echo "❌ Startdate is in the past!"
                echo "   Startdate: $STARTDATE"
                echo "   Today: $TODAY"
                echo "   Startdate must be today or a future date."
                EXIT_CODE=1
              else
                echo "✅ Startdate is today or in the future"
              fi
            fi
            
            # TODO: Check: Reviewer alias is present (commented for future use)
            # if [ -z "$REVIEWER" ] || [ "$REVIEWER" = "null" ]; then
            #   echo "❌ Reviewer alias is missing!"
            #   echo "   Please provide a valid reviewer alias in the lease.yaml file."
            #   EXIT_CODE=1
            # else
            #   echo "✅ Reviewer alias is present: $REVIEWER"
            # fi
            
            echo "-----------------------------------------"
          done
          
          echo ""
          echo "========================================="
          echo "Validation Summary"
          echo "========================================="
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "✅ All validations passed!"
          else
            echo "❌ Validation failed. Please fix the errors above."
          fi
          
          exit $EXIT_CODE
