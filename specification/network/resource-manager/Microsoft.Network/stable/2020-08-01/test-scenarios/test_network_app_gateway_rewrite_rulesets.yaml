scope: ResourceGroup
testScenarios:
  - description: test_network_app_gateway_rewrite_rulesets
    steps:
      - step: RawStep_1073
        method: GET
        rawUrl: >-
          https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourcegroups/cli_test_ag_rewrite_rulesets000001?api-version=2020-10-01
        requestHeaders:
          cache-control: no-cache
          content-length: '428'
          content-type: application/json; charset=utf-8
          date: Wed, 24 Feb 2021 11:19:50 GMT
          expires: '-1'
          pragma: no-cache
          strict-transport-security: max-age=31536000; includeSubDomains
          vary: Accept-Encoding
          x-content-type-options: nosniff
        responseExpected: >-
          {"id":"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_ag_rewrite_rulesets000001","name":"cli_test_ag_rewrite_rulesets000001","type":"Microsoft.Resources/resourceGroups","location":"westus","tags":{"product":"azurecli","cause":"automation","date":"2021-02-24T11:19:48Z"},"properties":{"provisioningState":"Succeeded"}}
      - step: Create_publicIPAddresses_pip1
        resourceName: publicIPAddresses_pip1
        exampleFile: ../examples/Create_publicIPAddresses_pip1_Generated_1075.json
        operationId: PublicIPAddresses_CreateOrUpdate
      - step: RawStep_1076
        method: GET
        rawUrl: >-
          https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourcegroups/cli_test_ag_rewrite_rulesets000001?api-version=2020-10-01
        requestHeaders:
          cache-control: no-cache
          content-length: '428'
          content-type: application/json; charset=utf-8
          date: Wed, 24 Feb 2021 11:19:59 GMT
          expires: '-1'
          pragma: no-cache
          strict-transport-security: max-age=31536000; includeSubDomains
          vary: Accept-Encoding
          x-content-type-options: nosniff
        responseExpected: >-
          {"id":"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_ag_rewrite_rulesets000001","name":"cli_test_ag_rewrite_rulesets000001","type":"Microsoft.Resources/resourceGroups","location":"westus","tags":{"product":"azurecli","cause":"automation","date":"2021-02-24T11:19:48Z"},"properties":{"provisioningState":"Succeeded"}}
      - step: RawStep_1077
        method: GET
        rawUrl: >-
          https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resources?$filter=resourceGroup%20eq%20%27cli_test_ag_rewrite_rulesets000001%27%20and%20name%20eq%20%27None%27%20and%20resourceType%20eq%20%27Microsoft.Network%2FvirtualNetworks%27&api-version=2020-10-01
        requestHeaders:
          cache-control: no-cache
          content-length: '12'
          content-type: application/json; charset=utf-8
          date: Wed, 24 Feb 2021 11:20:00 GMT
          expires: '-1'
          pragma: no-cache
          strict-transport-security: max-age=31536000; includeSubDomains
          vary: Accept-Encoding
          x-content-type-options: nosniff
        responseExpected: '{"value":[]}'
      - step: RawStep_1078
        method: GET
        rawUrl: >-
          https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resources?$filter=resourceGroup%20eq%20%27cli_test_ag_rewrite_rulesets000001%27%20and%20name%20eq%20%27pip1%27%20and%20resourceType%20eq%20%27Microsoft.Network%2FpublicIPAddresses%27&api-version=2020-10-01
        requestHeaders:
          cache-control: no-cache
          content-length: '337'
          content-type: application/json; charset=utf-8
          date: Wed, 24 Feb 2021 11:20:00 GMT
          expires: '-1'
          pragma: no-cache
          strict-transport-security: max-age=31536000; includeSubDomains
          vary: Accept-Encoding
          x-content-type-options: nosniff
        responseExpected: >-
          {"value":[{"id":"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_ag_rewrite_rulesets000001/providers/Microsoft.Network/publicIPAddresses/pip1","name":"pip1","type":"Microsoft.Network/publicIPAddresses","sku":{"name":"Standard","tier":"Regional"},"location":"westus"}]}
      - step: RawStep_1079
        method: PUT
        rawUrl: >-
          https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourcegroups/cli_test_ag_rewrite_rulesets000001/providers/Microsoft.Resources/deployments/mock-deployment?api-version=2020-10-01
        requestBody: >-
          {"properties":{"template":{"$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","parameters":{},"variables":{"appGwID":"[resourceId('Microsoft.Network/applicationGateways',
          'gw1')]"},"resources":[{"name":"gw1Vnet","type":"Microsoft.Network/virtualNetworks","location":"westus","apiVersion":"2015-06-15","dependsOn":[],"tags":{},"properties":{"addressSpace":{"addressPrefixes":["10.0.0.0/16"]},"subnets":[{"name":"default","properties":{"addressPrefix":"10.0.0.0/24"}}]}},{"type":"Microsoft.Network/applicationGateways","name":"gw1","location":"westus","tags":{},"apiVersion":"2020-08-01","dependsOn":["Microsoft.Network/virtualNetworks/gw1Vnet"],"properties":{"backendAddressPools":[{"name":"appGatewayBackendPool"}],"backendHttpSettingsCollection":[{"name":"appGatewayBackendHttpSettings","properties":{"Port":80,"Protocol":"Http","CookieBasedAffinity":"disabled","connectionDraining":{"enabled":false,"drainTimeoutInSec":1}}}],"frontendIPConfigurations":[{"name":"appGatewayFrontendIP","properties":{"publicIPAddress":{"id":"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_ag_rewrite_rulesets000001/providers/Microsoft.Network/publicIPAddresses/pip1"}}}],"frontendPorts":[{"name":"appGatewayFrontendPort","properties":{"Port":80}}],"gatewayIPConfigurations":[{"name":"appGatewayFrontendIP","properties":{"subnet":{"id":"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_ag_rewrite_rulesets000001/providers/Microsoft.Network/virtualNetworks/gw1Vnet/subnets/default"}}}],"httpListeners":[{"name":"appGatewayHttpListener","properties":{"FrontendIpConfiguration":{"Id":"[concat(variables('appGwID'),
          '/frontendIPConfigurations/appGatewayFrontendIP')]"},"FrontendPort":{"Id":"[concat(variables('appGwID'),
          '/frontendPorts/appGatewayFrontendPort')]"},"Protocol":"http","SslCertificate":null}}],"sku":{"name":"Standard_v2","tier":"Standard_v2","capacity":2},"requestRoutingRules":[{"Name":"rule1","properties":{"RuleType":"Basic","httpListener":{"id":"[concat(variables('appGwID'),
          '/httpListeners/appGatewayHttpListener')]"},"backendAddressPool":{"id":"[concat(variables('appGwID'),
          '/backendAddressPools/appGatewayBackendPool')]"},"backendHttpSettings":{"id":"[concat(variables('appGwID'),
          '/backendHttpSettingsCollection/appGatewayBackendHttpSettings')]"}}}],"privateLinkConfigurations":[]},"zones":null}],"outputs":{"applicationGateway":{"type":"object","value":"[reference('gw1')]"}}},"parameters":{},"mode":"Incremental"}}
        requestHeaders:
          azure-asyncoperation: >-
            https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourcegroups/cli_test_ag_rewrite_rulesets000001/providers/Microsoft.Resources/deployments/ag_deploy_EZXJ48VbdcrZ4fZzjDdxPtigI6LPEC4a/operationStatuses/08585874412829837501?api-version=2020-10-01
          cache-control: no-cache
          content-length: '1351'
          content-type: application/json; charset=utf-8
          date: Wed, 24 Feb 2021 11:20:05 GMT
          expires: '-1'
          pragma: no-cache
          strict-transport-security: max-age=31536000; includeSubDomains
          x-content-type-options: nosniff
          x-ms-ratelimit-remaining-subscription-writes: '1189'
        statusCode: 201
        responseExpected: >-
          {"id":"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_ag_rewrite_rulesets000001/providers/Microsoft.Resources/deployments/ag_deploy_EZXJ48VbdcrZ4fZzjDdxPtigI6LPEC4a","name":"ag_deploy_EZXJ48VbdcrZ4fZzjDdxPtigI6LPEC4a","type":"Microsoft.Resources/deployments","properties":{"templateHash":"15309116997247617120","parameters":{},"mode":"Incremental","provisioningState":"Accepted","timestamp":"2021-02-24T11:20:04.7932879Z","duration":"PT2.2994161S","correlationId":"18704d33-c47a-4d88-a264-ab4a6e1e647c","providers":[{"namespace":"Microsoft.Network","resourceTypes":[{"resourceType":"virtualNetworks","locations":["westus"]},{"resourceType":"applicationGateways","locations":["westus"]}]}],"dependencies":[{"dependsOn":[{"id":"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_ag_rewrite_rulesets000001/providers/Microsoft.Network/virtualNetworks/gw1Vnet","resourceType":"Microsoft.Network/virtualNetworks","resourceName":"gw1Vnet"}],"id":"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_ag_rewrite_rulesets000001/providers/Microsoft.Network/applicationGateways/gw1","resourceType":"Microsoft.Network/applicationGateways","resourceName":"gw1"}]}}
      - step: ApplicationGateways_Get_1080
        exampleFile: ../examples/ApplicationGateways_Get_1080_Generated.json
        operationId: ApplicationGateways_Get
      - step: Create_applicationGateways_gw1
        resourceName: applicationGateways_gw1
        exampleFile: ../examples/Create_applicationGateways_gw1_Generated.json
        operationId: ApplicationGateways_CreateOrUpdate
      - step: Update_applicationGateways_gw1_1083
        resourceName: applicationGateways_gw1
        operationId: ApplicationGateways_CreateOrUpdate
        resourceUpdate:
          - add: /properties/rewriteRuleSets/0/properties/rewriteRules/0
            value:
              name: rule1
              ruleSequence: 123
              actionSet:
                requestHeaderConfigurations:
                  - headerName: foo
                    headerValue: bar
                responseHeaderConfigurations:
                  - headerName: cat
                    headerValue: hat
              conditions: []
      - step: Update_applicationGateways_gw1_1085
        resourceName: applicationGateways_gw1
        operationId: ApplicationGateways_CreateOrUpdate
        resourceUpdate:
          - replace: >-
              /properties/rewriteRuleSets/0/properties/rewriteRules/0/ruleSequence
            value: 321
          - replace: >-
              /properties/rewriteRuleSets/0/properties/rewriteRules/0/actionSet/requestHeaderConfigurations/0
            value:
              headerName: bar
              headerValue: foo
          - replace: >-
              /properties/rewriteRuleSets/0/properties/rewriteRules/0/actionSet/responseHeaderConfigurations/0
            value:
              headerName: hat
              headerValue: cat
      - step: Update_applicationGateways_gw1_1087
        resourceName: applicationGateways_gw1
        operationId: ApplicationGateways_CreateOrUpdate
        resourceUpdate:
          - remove: >-
              /properties/rewriteRuleSets/0/properties/rewriteRules/0/actionSet/responseHeaderConfigurations/0
      - step: ApplicationGateways_ListAvailableRequestHeaders_1088
        exampleFile: >-
          ../examples/ApplicationGateways_ListAvailableRequestHeaders_1088_Generated.json
        operationId: ApplicationGateways_ListAvailableRequestHeaders
      - step: ApplicationGateways_ListAvailableResponseHeaders_1089
        exampleFile: >-
          ../examples/ApplicationGateways_ListAvailableResponseHeaders_1089_Generated.json
        operationId: ApplicationGateways_ListAvailableResponseHeaders
      - step: Update_applicationGateways_gw1_1091
        resourceName: applicationGateways_gw1
        operationId: ApplicationGateways_CreateOrUpdate
        resourceUpdate:
          - replace: /properties/provisioningState
            value: Succeeded
          - replace: /properties/operationalState
            value: Running
          - replace: /properties/gatewayIPConfigurations/0/properties/provisioningState
            value: Succeeded
          - replace: >-
              /properties/frontendIPConfigurations/0/properties/provisioningState
            value: Succeeded
          - replace: /properties/frontendPorts/0/properties/provisioningState
            value: Succeeded
          - replace: /properties/backendAddressPools/0/properties/provisioningState
            value: Succeeded
          - replace: >-
              /properties/backendHttpSettingsCollection/0/properties/provisioningState
            value: Succeeded
          - replace: /properties/httpListeners/0/properties/provisioningState
            value: Succeeded
          - replace: /properties/requestRoutingRules/0/properties/provisioningState
            value: Succeeded
          - replace: /properties/rewriteRuleSets/0/properties/provisioningState
            value: Succeeded
          - add: /properties/rewriteRuleSets/0/properties/rewriteRules/1
            value:
              name: rule2
              ruleSequence: 123
              actionSet:
                requestHeaderConfigurations:
                  - headerName: foo
                    headerValue: bar
                responseHeaderConfigurations:
                  - headerName: cat
                    headerValue: hat
                urlConfiguration:
                  modifiedPath: /def
                  modifiedQueryString: a=b&c=d%20f
                  reroute: false
              conditions: []
      - step: Update_applicationGateways_gw1_1093
        resourceName: applicationGateways_gw1
        operationId: ApplicationGateways_CreateOrUpdate
        resourceUpdate:
          - replace: >-
              /properties/rewriteRuleSets/0/properties/rewriteRules/1/ruleSequence
            value: 321
          - replace: >-
              /properties/rewriteRuleSets/0/properties/rewriteRules/1/actionSet/requestHeaderConfigurations/0
            value:
              headerName: bar
              headerValue: foo
          - replace: >-
              /properties/rewriteRuleSets/0/properties/rewriteRules/1/actionSet/responseHeaderConfigurations/0
            value:
              headerName: hat
              headerValue: cat
          - replace: >-
              /properties/rewriteRuleSets/0/properties/rewriteRules/1/actionSet/urlConfiguration/modifiedPath
            value: /def2
          - replace: >-
              /properties/rewriteRuleSets/0/properties/rewriteRules/1/actionSet/urlConfiguration/modifiedQueryString
            value: a=b&c=d%20f12
          - replace: >-
              /properties/rewriteRuleSets/0/properties/rewriteRules/1/actionSet/urlConfiguration/reroute
            value: true
      - step: Update_applicationGateways_gw1_1095
        resourceName: applicationGateways_gw1
        operationId: ApplicationGateways_CreateOrUpdate
        resourceUpdate:
          - replace: /properties/provisioningState
            value: Updating
          - replace: /properties/gatewayIPConfigurations/0/properties/provisioningState
            value: Updating
          - replace: >-
              /properties/frontendIPConfigurations/0/properties/provisioningState
            value: Updating
          - replace: /properties/frontendPorts/0/properties/provisioningState
            value: Updating
          - replace: /properties/backendAddressPools/0/properties/provisioningState
            value: Updating
          - replace: >-
              /properties/backendHttpSettingsCollection/0/properties/provisioningState
            value: Updating
          - replace: /properties/httpListeners/0/properties/provisioningState
            value: Updating
          - replace: /properties/requestRoutingRules/0/properties/provisioningState
            value: Updating
          - replace: /properties/rewriteRuleSets/0/properties/provisioningState
            value: Updating
          - remove: >-
              /properties/rewriteRuleSets/0/properties/rewriteRules/1/actionSet/responseHeaderConfigurations/0
      - step: Update_applicationGateways_gw1_1097
        resourceName: applicationGateways_gw1
        operationId: ApplicationGateways_CreateOrUpdate
        resourceUpdate:
          - add: >-
              /properties/rewriteRuleSets/0/properties/rewriteRules/0/conditions/0
            value:
              variable: http_req_Authorization
              pattern: ^Bearer
              ignoreCase: false
              negate: true
      - step: Update_applicationGateways_gw1_1099
        resourceName: applicationGateways_gw1
        operationId: ApplicationGateways_CreateOrUpdate
      - step: Update_applicationGateways_gw1_1101
        resourceName: applicationGateways_gw1
        operationId: ApplicationGateways_CreateOrUpdate
        resourceUpdate:
          - remove: >-
              /properties/rewriteRuleSets/0/properties/rewriteRules/0/conditions/0
      - step: ApplicationGateways_ListAvailableServerVariables_1102
        exampleFile: >-
          ../examples/ApplicationGateways_ListAvailableServerVariables_1102_Generated.json
        operationId: ApplicationGateways_ListAvailableServerVariables
      - step: Update_applicationGateways_gw1_1104
        resourceName: applicationGateways_gw1
        operationId: ApplicationGateways_CreateOrUpdate
        resourceUpdate:
          - remove: /properties/rewriteRuleSets/0/properties/rewriteRules/0
      - step: Update_applicationGateways_gw1_1106
        resourceName: applicationGateways_gw1
        operationId: ApplicationGateways_CreateOrUpdate
        resourceUpdate:
          - remove: /properties/rewriteRuleSets/0
    variables:
      publicIpAddressName: pip1
      applicationGatewayName: gw1
