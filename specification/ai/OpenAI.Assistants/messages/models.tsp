import "../main.tsp";
import "../tools/models.tsp";

import "@typespec/versioning";

namespace Azure.AI.OpenAI.Assistants;

using TypeSpec.Versioning;

/** A single message within an assistant thread, as provided during that thread's creation for its initial state. */
@added(ServiceApiVersions.v2024_05_01_preview)
model ThreadMessageOptions {
  /**
   * The role of the entity that is creating the message. Allowed values include:
   *   - `user`: Indicates the message is sent by an actual user and should be used in most cases to represent user-generated messages.
   *   - `assistant`: Indicates the message is generated by the assistant. Use this value to insert messages from the assistant into
   *     the conversation.
   */
  role: MessageRole;

  /** The textual content of the initial message. Currently, robust input including images and annotated text may only be provided via
   * a separate call to the create message API.
   */
  content: string;

  /** A list of files attached to the message, and the tools they should be added to. */
  #suppress "@azure-tools/typespec-azure-core/no-nullable" "OpenAI uses explicit nullability, distinct from optionality"
  attachments?: MessageAttachment[] | null;

  ...OptionalNullableMetadata;
}

@doc("A single, existing message within an assistant thread.")
@added(ServiceApiVersions.v2024_02_15_preview)
model ThreadMessage {
  @doc("The identifier, which can be referenced in API endpoints.")
  id: string;

  @doc("The object type, which is always 'thread.message'.")
  object: "thread.message";

  @encodedName("application/json", "created_at")
  @encode(DateTimeKnownEncoding.unixTimestamp, int32)
  @doc("The Unix timestamp, in seconds, representing when this object was created.")
  createdAt: utcDateTime;

  @encodedName("application/json", "thread_id")
  @doc("The ID of the thread that this message belongs to.")
  threadId: string;

  /** The status of the message. */
  @added(ServiceApiVersions.v2024_02_15_preview)
  status: MessageStatus;

  /** On an incomplete message, details about why the message is incomplete. */
  #suppress "@azure-tools/typespec-azure-core/no-nullable" "OpenAI uses explicit nullability, distinct from optionality"
  @encodedName("application/json", "incomplete_details")
  @added(ServiceApiVersions.v2024_02_15_preview)
  incompleteDetails: MessageIncompleteDetails | null;

  /** The Unix timestamp (in seconds) for when the message was completed. */
  #suppress "@azure-tools/typespec-azure-core/no-nullable" "OpenAI uses explicit nullability, distinct from optionality"
  @encode(DateTimeKnownEncoding.unixTimestamp, int32)
  @encodedName("application/json", "completed_at")
  @added(ServiceApiVersions.v2024_02_15_preview)
  completedAt: utcDateTime | null;

  /** The Unix timestamp (in seconds) for when the message was marked as incomplete. */
  #suppress "@azure-tools/typespec-azure-core/no-nullable" "OpenAI uses explicit nullability, distinct from optionality"
  @encode(DateTimeKnownEncoding.unixTimestamp, int32)
  @encodedName("application/json", "incomplete_at")
  @added(ServiceApiVersions.v2024_02_15_preview)
  incompleteAt: utcDateTime | null;

  @doc("The role associated with the assistant thread message.")
  role: MessageRole;

  @doc("The list of content items associated with the assistant thread message.")
  content: MessageContent[];

  #suppress "@azure-tools/typespec-azure-core/no-nullable" "OpenAI uses explicit nullability, distinct from optionality"
  @encodedName("application/json", "assistant_id")
  @doc("If applicable, the ID of the assistant that authored this message.")
  assistantId: string | null;

  #suppress "@azure-tools/typespec-azure-core/no-nullable" "OpenAI uses explicit nullability, distinct from optionality"
  @encodedName("application/json", "run_id")
  @doc("If applicable, the ID of the run associated with the authoring of this message.")
  runId: string | null;

  /** A list of files attached to the message, and the tools they were added to. */
  #suppress "@azure-tools/typespec-azure-core/no-nullable" "OpenAI uses explicit nullability, distinct from optionality"
  @added(ServiceApiVersions.v2024_05_01_preview)
  attachments: MessageAttachment[] | null;

  ...RequiredNullableMetadata;
}

/** This describes to which tools a file has been attached. */
@added(ServiceApiVersions.v2024_05_01_preview)
model MessageAttachment {
  /** The ID of the file to attach to the message. */
  @encodedName("application/json", "file_id")
  fileId: string;

  /** The tools to add to this file. */
  tools: MessageAttachmentToolDefinition[];
}

/** The possible tools to which files will be added by this message */
#suppress "@azure-tools/typespec-autorest/union-unsupported" "This union is defined according to the OpenAI API"
@added(ServiceApiVersions.v2024_05_01_preview)
union MessageAttachmentToolDefinition {
  CodeInterpreterToolDefinition | FileSearchToolDefinition,
}

// Message content types: "text" | "image_file"

@discriminator("type")
@doc("An abstract representation of a single item of thread message content.")
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageContent {
  #suppress "@azure-tools/typespec-azure-core/no-string-discriminator" "Existing"
  @doc("The object type.")
  type: string;
}

@doc("A representation of a textual item of thread message content.")
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageTextContent extends MessageContent {
  @doc("The object type, which is always 'text'.")
  type: "text";

  @doc("The text and associated annotations for this thread message content item.")
  text: MessageTextDetails;
}

@doc("A representation of image file content in a thread message.")
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageImageFileContent extends MessageContent {
  @doc("The object type, which is always 'image_file'.")
  type: "image_file";

  @encodedName("application/json", "image_file")
  @doc("The image file for this thread message content item.")
  imageFile: MessageImageFileDetails;
}

// Text content details

@doc("The text and associated annotations for a single item of assistant thread message content.")
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageTextDetails {
  @doc("The text data.")
  value: string;

  @doc("A list of annotations associated with this text.")
  annotations: MessageTextAnnotation[];
}

// Annotations, used by text content: "file_citation" | "file_path"

@discriminator("type")
@doc("An abstract representation of an annotation to text thread message content.")
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageTextAnnotation {
  #suppress "@azure-tools/typespec-azure-core/no-string-discriminator" "Existing"
  @doc("The object type.")
  type: string;

  @doc("The textual content associated with this text annotation item.")
  text: string;
}

// File citation annotation + details

@doc("A citation within the message that points to a specific quote from a specific File associated with the assistant or the message. Generated when the assistant uses the 'file_search' tool to search files.")
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageTextFileCitationAnnotation extends MessageTextAnnotation {
  @doc("The object type, which is always 'file_citation'.")
  type: "file_citation";

  @encodedName("application/json", "file_citation")
  @doc("""
    A citation within the message that points to a specific quote from a specific file.
    Generated when the assistant uses the "file_search" tool to search files.
    """)
  fileCitation: MessageTextFileCitationDetails;

  @encodedName("application/json", "start_index")
  @doc("The first text index associated with this text annotation.")
  startIndex?: int32;

  @encodedName("application/json", "end_index")
  @doc("The last text index associated with this text annotation.")
  endIndex?: int32;
}

@doc("A representation of a file-based text citation, as used in a file-based annotation of text thread message content.")
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageTextFileCitationDetails {
  @encodedName("application/json", "file_id")
  @doc("The ID of the file associated with this citation.")
  fileId: string;

  @doc("The specific quote cited in the associated file.")
  quote: string;
}

// File path annotation + details

@doc("A citation within the message that points to a file located at a specific path.")
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageTextFilePathAnnotation extends MessageTextAnnotation {
  @doc("The object type, which is always 'file_path'.")
  type: "file_path";

  @encodedName("application/json", "file_path")
  @doc("A URL for the file that's generated when the assistant used the code_interpreter tool to generate a file.")
  filePath: MessageTextFilePathDetails;

  @encodedName("application/json", "start_index")
  @doc("The first text index associated with this text annotation.")
  startIndex?: int32;

  @encodedName("application/json", "end_index")
  @doc("The last text index associated with this text annotation.")
  endIndex?: int32;
}

@doc("An encapsulation of an image file ID, as used by message image content.")
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageTextFilePathDetails {
  @doc("The ID of the specific file that the citation is from.")
  @encodedName("application/json", "file_id")
  fileId: string;
}

// Image file content details

@doc("An image reference, as represented in thread message content.")
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageImageFileDetails {
  @encodedName("application/json", "file_id")
  @doc("The ID for the file associated with this image.")
  fileId: string;
}

/** The possible execution status values for a thread message. */
@added(ServiceApiVersions.v2024_02_15_preview)
union MessageStatus {
  string,

  /** A run is currently creating this message. */
  inProgress: "in_progress",

  /** This message is incomplete. See incomplete_details for more information. */
  incomplete: "incomplete",

  /** This message was successfully completed by a run. */
  completed: "completed",
}

/** Information providing additional detail about a message entering an incomplete status. */
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageIncompleteDetails {
  /** The provided reason describing why the message was marked as incomplete. */
  reason: MessageIncompleteDetailsReason;
}

/** A set of reasons describing why a message is marked as incomplete. */
@added(ServiceApiVersions.v2024_02_15_preview)
union MessageIncompleteDetailsReason {
  string,

  /** The run generating the message was terminated due to content filter flagging. */
  contentFilter: "content_filter",

  /** The run generating the message exhausted available tokens before completion. */
  maxTokens: "max_tokens",

  /** The run generating the message was cancelled before completion. */
  runCancelled: "run_cancelled",

  /** The run generating the message failed. */
  runFailed: "run_failed",

  /** The run generating the message expired. */
  runExpired: "run_expired",
}

//
// These types are specifically used for streaming.
//

/** Represents a message delta i.e. any changed fields on a message during streaming. */
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageDeltaChunk {
  /** The identifier of the message, which can be referenced in API endpoints. */
  id: string;

  /** The object type, which is always `thread.message.delta`. */
  object: "thread.message.delta";

  /** The delta containing the fields that have changed on the Message. */
  delta: MessageDelta;
}

/** Represents the typed 'delta' payload within a streaming message delta chunk. */
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageDelta {
  /** The entity that produced the message. */
  role: MessageRole;

  /** The content of the message as an array of text and/or images. */
  content: MessageDeltaContent[];
}

/** The abstract base representation of a partial streamed message content payload. */
@discriminator("type")
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageDeltaContent {
  /** The index of the content part of the message. */
  index: int32;

  /** The type of content for this content part. */
  #suppress "@azure-tools/typespec-azure-core/no-string-discriminator" "Existing"
  type: string;
}

/** Represents a streamed image file content part within a streaming message delta chunk. */
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageDeltaImageFileContent extends MessageDeltaContent {
  /** The type of content for this content part, which is always "image_file." */
  type: "image_file";

  /** The image_file data. */
  @encodedName("application/json", "image_file")
  imageFile?: MessageDeltaImageFileContentObject;
}

/** Represents the 'image_file' payload within streaming image file content. */
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageDeltaImageFileContentObject {
  /** The file ID of the image in the message content. */
  @encodedName("application/json", "file_id")
  fileId?: string;
}

/** Represents a streamed text content part within a streaming message delta chunk. */
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageDeltaTextContentObject extends MessageDeltaContent {
  /** The type of content for this content part, which is always "text." */
  type: "text";

  /** The text content details. */
  text?: MessageDeltaTextContent;
}

/** Represents the data of a streamed text content part within a streaming message delta chunk. */
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageDeltaTextContent {
  /** The data that makes up the text. */
  value?: string;

  /** Annotations for the text. */
  annotations?: MessageDeltaTextAnnotation[];
}

/** The abstract base representation of a streamed text content part's text annotation. */
@discriminator("type")
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageDeltaTextAnnotation {
  /** The index of the annotation within a text content part. */
  index: int32;

  /** The type of the text content annotation. */
  #suppress "@azure-tools/typespec-azure-core/no-string-discriminator" "Existing"
  type: string;
}

/** Represents a streamed file citation applied to a streaming text content part. */
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageDeltaTextFileCitationAnnotationObject
  extends MessageDeltaTextAnnotation {
  /** The type of the text content annotation, which is always "file_citation." */
  type: "file_citation";

  /** The file citation information. */
  @encodedName("application/json", "file_citation")
  fileCitation?: MessageDeltaTextFileCitationAnnotation;

  /** The text in the message content that needs to be replaced */
  text?: string;

  /** The start index of this annotation in the content text. */
  @encodedName("application/json", "start_index")
  startIndex?: int32;

  /** The end index of this annotation in the content text. */
  @encodedName("application/json", "end_index")
  endIndex?: int32;
}

/** Represents the data of a streamed file citation as applied to a streaming text content part. */
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageDeltaTextFileCitationAnnotation {
  /** The ID of the specific file the citation is from. */
  @encodedName("application/json", "file_id")
  fileId?: string;

  /** The specific quote in the cited file. */
  quote?: string;
}

/** Represents a streamed file path annotation applied to a streaming text content part. */
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageDeltaTextFilePathAnnotationObject
  extends MessageDeltaTextAnnotation {
  /** The type of the text content annotation, which is always "file_path." */
  type: "file_path";

  /** The file path information. */
  @encodedName("application/json", "file_path")
  filePath?: MessageDeltaTextFilePathAnnotation;

  /** The start index of this annotation in the content text. */
  @encodedName("application/json", "start_index")
  startIndex?: int32;

  /** The end index of this annotation in the content text. */
  @encodedName("application/json", "end_index")
  endIndex?: int32;

  /** The text in the message content that needs to be replaced */
  text?: string;
}

/** Represents the data of a streamed file path annotation as applied to a streaming text content part. */
@added(ServiceApiVersions.v2024_02_15_preview)
model MessageDeltaTextFilePathAnnotation {
  /** The file ID for the annotation. */
  @encodedName("application/json", "file_id")
  fileId?: string;
}
