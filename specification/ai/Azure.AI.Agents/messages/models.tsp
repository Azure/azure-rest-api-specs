import "../tools/models.tsp";
import "@typespec/versioning";

namespace Azure.AI.Agents;

using TypeSpec.Versioning;

#suppress "@azure-tools/typespec-autorest/union-unsupported" "Union of string | array is intentional (OpenAPI 3 can handle oneOf)."
@doc("Represents the message content for creating a new message. It can be either a simple text string or a list of typed content blocks (text, image_file, image_url).")
union MessageInputContent {
  @doc("A plain text message if rich content is not needed.")
  text: string,

  @doc("A list of typed content blocks for richer messages, such as text blocks, image-file references, or external image-URL references.")
  blocks: MessageInputContentBlock[],
}

@doc("Specifies the kind of content block within a message. Could be text, an image file, an external image URL, or an unknown future type.")
union MessageBlockType {
  @doc("Indicates a block containing text content.")
  text: "text",

  @doc("Indicates a block referencing an internally uploaded image file.")
  image_file: "image_file",

  @doc("Indicates a block referencing an external image URL.")
  image_url: "image_url",

  @doc("A future or unrecognized block type (fallback).")
  string,
}

@doc("Defines a single content block when creating a message. The 'type' field determines whether it is text, an image file, or an external image URL, etc.")
@discriminator("type")
@added(Versions.v2025_05_01)
model MessageInputContentBlock {
  @doc("Specifies which kind of content block this is (text, image_file, image_url, etc.).")
  type: MessageBlockType;
}

@doc("A text block in a new message, containing plain text content.")
@added(Versions.v2025_05_01)
model MessageInputTextBlock extends MessageInputContentBlock {
  @doc("Must be 'text' for a text block.")
  type: "text";

  @doc("The plain text content for this block.")
  text: string;
}

@doc("An image-file block in a new message, referencing an internally uploaded image by file ID.")
@added(Versions.v2025_05_01)
model MessageInputImageFileBlock extends MessageInputContentBlock {
  @doc("Must be 'image_file' for an internally uploaded image block.")
  type: "image_file";

  @doc("Information about the referenced image file, including file ID and optional detail level.")
  @encodedName("application/json", "image_file")
  imageFile: MessageImageFileParam;
}

@doc("An image-URL block in a new message, referencing an external image by URL.")
@added(Versions.v2025_05_01)
model MessageInputImageUrlBlock extends MessageInputContentBlock {
  @doc("Must be 'image_url' for an externally hosted image block.")
  type: "image_url";

  @doc("Information about the external image URL, including the URL and optional detail level.")
  @encodedName("application/json", "image_url")
  imageUrl: MessageImageUrlParam;
}

@doc("Specifies an image's detail level. Can be 'auto', 'low', 'high', or an unknown future value.")
union ImageDetailLevel {
  @doc("Automatically select an appropriate detail level.")
  auto: "auto",

  @doc("Use a lower detail level to reduce bandwidth or cost.")
  low: "low",

  @doc("Use a higher detail levelâ€”potentially more resource-intensive.")
  high: "high",

  @doc("A future or unrecognized detail level (fallback).")
  string,
}

@doc("Defines how an internally uploaded image file is referenced when creating an image-file block.")
@added(Versions.v2025_05_01)
model MessageImageFileParam {
  @doc("The ID of the previously uploaded image file.")
  @encodedName("application/json", "file_id")
  fileId: string;

  @doc("Optional detail level for the image (auto, low, or high).")
  detail?: ImageDetailLevel;
}

@doc("Defines how an external image URL is referenced when creating an image-URL block.")
@added(Versions.v2025_05_01)
model MessageImageUrlParam {
  @doc("The publicly accessible URL of the external image.")
  url: string;

  @doc("Optional detail level for the image (auto, low, or high). Defaults to 'auto' if not specified.")
  detail?: ImageDetailLevel;
}

/**
 * A single message within an agent thread,
 * as provided during that thread's creation for its initial state.
 */
@added(Versions.v2025_05_01)
model ThreadMessageOptions {
  /**
   * The role of the entity that is creating the message. Allowed values include:
   * `user`, which indicates the message is sent by an actual user (and should be
   * used in most cases to represent user-generated messages), and `assistant`,
   * which indicates the message is generated by the agent (use this value to insert
   * messages from the agent into the conversation).
   */
  role: MessageRole;

  /**
   * The content of the initial message. This may be a basic string (if you only
   * need text) or an array of typed content blocks (for example, text, image_file,
   * image_url, and so on).
   */
  content: MessageInputContent;

  /**
   * A list of files attached to the message, and the tools they should be added to.
   */
  #suppress "@azure-tools/typespec-azure-core/no-nullable" "OpenAI uses explicit nullability, distinct from optionality"
  attachments?: MessageAttachment[] | null;

  ...OptionalNullableMetadata;
}

@doc("A single, existing message within an agent thread.")
@added(Versions.v2025_05_01)
model ThreadMessage {
  @doc("The identifier, which can be referenced in API endpoints.")
  id: string;

  @doc("The object type, which is always 'thread.message'.")
  object: "thread.message";

  @encodedName("application/json", "created_at")
  @encode(DateTimeKnownEncoding.unixTimestamp, int32)
  @doc("The Unix timestamp, in seconds, representing when this object was created.")
  createdAt: utcDateTime;

  @encodedName("application/json", "thread_id")
  @doc("The ID of the thread that this message belongs to.")
  threadId: string;

  /** The status of the message. */
  status: MessageStatus;

  /** On an incomplete message, details about why the message is incomplete. */
  #suppress "@azure-tools/typespec-azure-core/no-nullable" "OpenAI uses explicit nullability, distinct from optionality"
  @encodedName("application/json", "incomplete_details")
  incompleteDetails: MessageIncompleteDetails | null;

  /** The Unix timestamp (in seconds) for when the message was completed. */
  #suppress "@azure-tools/typespec-azure-core/no-nullable" "OpenAI uses explicit nullability, distinct from optionality"
  @encode(DateTimeKnownEncoding.unixTimestamp, int32)
  @encodedName("application/json", "completed_at")
  completedAt: utcDateTime | null;

  /** The Unix timestamp (in seconds) for when the message was marked as incomplete. */
  #suppress "@azure-tools/typespec-azure-core/no-nullable" "OpenAI uses explicit nullability, distinct from optionality"
  @encode(DateTimeKnownEncoding.unixTimestamp, int32)
  @encodedName("application/json", "incomplete_at")
  incompleteAt: utcDateTime | null;

  @doc("The role associated with the agent thread message.")
  role: MessageRole;

  @doc("The list of content items associated with the agent thread message.")
  content: MessageContent[];

  #suppress "@azure-tools/typespec-azure-core/no-nullable" "OpenAI uses explicit nullability, distinct from optionality"
  @encodedName("application/json", "assistant_id")
  @doc("If applicable, the ID of the agent that authored this message.")
  assistantId: string | null;

  #suppress "@azure-tools/typespec-azure-core/no-nullable" "OpenAI uses explicit nullability, distinct from optionality"
  @encodedName("application/json", "run_id")
  @doc("If applicable, the ID of the run associated with the authoring of this message.")
  runId: string | null;

  /** A list of files attached to the message, and the tools they were added to. */
  #suppress "@azure-tools/typespec-azure-core/no-nullable" "OpenAI uses explicit nullability, distinct from optionality"
  attachments: MessageAttachment[] | null;

  ...RequiredNullableMetadata;
}

/** This describes to which tools a file has been attached. */
@added(Versions.v2025_05_01)
model MessageAttachment {
  /** The ID of the file to attach to the message. */
  @encodedName("application/json", "file_id")
  fileId?: string;

  /** The data source to be used. This option is mutually exclusive with fileId. */
  @doc("Azure asset ID.")
  @encodedName("application/json", "data_source")
  dataSource?: VectorStoreDataSource;

  /** The tools to add to this file. */
  tools: MessageAttachmentToolDefinition[];
}

/** The possible tools to which files will be added by this message */
#suppress "@azure-tools/typespec-autorest/union-unsupported" "This union is defined according to the OpenAI API"
union MessageAttachmentToolDefinition {
  CodeInterpreterToolDefinition | FileSearchToolDefinition,
}

// Message content types: "text" | "image_file"

@discriminator("type")
@doc("An abstract representation of a single item of thread message content.")
@added(Versions.v2025_05_01)
model MessageContent {
  #suppress "@azure-tools/typespec-azure-core/no-string-discriminator" "Existing"
  @doc("The object type.")
  type: string;
}

@doc("A representation of a textual item of thread message content.")
@added(Versions.v2025_05_01)
model MessageTextContent extends MessageContent {
  @doc("The object type, which is always 'text'.")
  type: "text";

  @doc("The text and associated annotations for this thread message content item.")
  text: MessageTextDetails;
}

@doc("A representation of image file content in a thread message.")
@added(Versions.v2025_05_01)
model MessageImageFileContent extends MessageContent {
  @doc("The object type, which is always 'image_file'.")
  type: "image_file";

  @encodedName("application/json", "image_file")
  @doc("The image file for this thread message content item.")
  imageFile: MessageImageFileDetails;
}

// Text content details

@doc("The text and associated annotations for a single item of agent thread message content.")
@added(Versions.v2025_05_01)
model MessageTextDetails {
  @doc("The text data.")
  value: string;

  @doc("A list of annotations associated with this text.")
  annotations: MessageTextAnnotation[];
}

// Annotations, used by text content: "file_citation" | "file_path" | "url_citation"

@discriminator("type")
@doc("An abstract representation of an annotation to text thread message content.")
@added(Versions.v2025_05_01)
model MessageTextAnnotation {
  #suppress "@azure-tools/typespec-azure-core/no-string-discriminator" "Existing"
  @doc("The object type.")
  type: string;

  @doc("The textual content associated with this text annotation item.")
  text: string;
}

// URL citation annotation + details

@doc("A citation within the message that points to a specific URL associated with the message. Generated when the agent uses tools such as 'bing_grounding' to search the Internet.")
@added(Versions.v2025_05_01)
model MessageTextUrlCitationAnnotation extends MessageTextAnnotation {
  @doc("The object type, which is always 'url_citation'.")
  type: "url_citation";

  @encodedName("application/json", "url_citation")
  @doc("The details of the URL citation.")
  urlCitation: MessageTextUrlCitationDetails;

  @encodedName("application/json", "start_index")
  @doc("The first text index associated with this text annotation.")
  startIndex?: int32;

  @encodedName("application/json", "end_index")
  @doc("The last text index associated with this text annotation.")
  endIndex?: int32;
}

@doc("A representation of a URL citation, as used in text thread message content.")
@added(Versions.v2025_05_01)
model MessageTextUrlCitationDetails {
  @doc("The URL associated with this citation.")
  url: string;

  @doc("The title of the URL.")
  title?: string;
}

// File citation annotation + details

@doc("A citation within the message that points to a specific quote from a specific File associated with the agent or the message. Generated when the agent uses the 'file_search' tool to search files.")
@added(Versions.v2025_05_01)
model MessageTextFileCitationAnnotation extends MessageTextAnnotation {
  @doc("The object type, which is always 'file_citation'.")
  type: "file_citation";

  @encodedName("application/json", "file_citation")
  @doc("""
    A citation within the message that points to a specific quote from a specific file.
    Generated when the agent uses the "file_search" tool to search files.
    """)
  fileCitation: MessageTextFileCitationDetails;

  @encodedName("application/json", "start_index")
  @doc("The first text index associated with this text annotation.")
  startIndex?: int32;

  @encodedName("application/json", "end_index")
  @doc("The last text index associated with this text annotation.")
  endIndex?: int32;
}

@doc("A representation of a file-based text citation, as used in a file-based annotation of text thread message content.")
@added(Versions.v2025_05_01)
model MessageTextFileCitationDetails {
  @encodedName("application/json", "file_id")
  @doc("The ID of the file associated with this citation.")
  fileId: string;

  @doc("The specific quote cited in the associated file.")
  quote: string;
}

// File path annotation + details

@doc("A citation within the message that points to a file located at a specific path.")
@added(Versions.v2025_05_01)
model MessageTextFilePathAnnotation extends MessageTextAnnotation {
  @doc("The object type, which is always 'file_path'.")
  type: "file_path";

  @encodedName("application/json", "file_path")
  @doc("A URL for the file that's generated when the agent used the code_interpreter tool to generate a file.")
  filePath: MessageTextFilePathDetails;

  @encodedName("application/json", "start_index")
  @doc("The first text index associated with this text annotation.")
  startIndex?: int32;

  @encodedName("application/json", "end_index")
  @doc("The last text index associated with this text annotation.")
  endIndex?: int32;
}

@doc("An encapsulation of an image file ID, as used by message image content.")
@added(Versions.v2025_05_01)
model MessageTextFilePathDetails {
  @doc("The ID of the specific file that the citation is from.")
  @encodedName("application/json", "file_id")
  fileId: string;
}

// Image file content details

@doc("An image reference, as represented in thread message content.")
@added(Versions.v2025_05_01)
model MessageImageFileDetails {
  @encodedName("application/json", "file_id")
  @doc("The ID for the file associated with this image.")
  fileId: string;
}

/** The possible execution status values for a thread message. */
union MessageStatus {
  string,

  /** A run is currently creating this message. */
  inProgress: "in_progress",

  /** This message is incomplete. See incomplete_details for more information. */
  incomplete: "incomplete",

  /** This message was successfully completed by a run. */
  completed: "completed",
}

/** Information providing additional detail about a message entering an incomplete status. */
@added(Versions.v2025_05_01)
model MessageIncompleteDetails {
  /** The provided reason describing why the message was marked as incomplete. */
  reason: MessageIncompleteDetailsReason;
}

/** A set of reasons describing why a message is marked as incomplete. */
union MessageIncompleteDetailsReason {
  string,

  /** The run generating the message was terminated due to content filter flagging. */
  contentFilter: "content_filter",

  /** The run generating the message exhausted available tokens before completion. */
  maxTokens: "max_tokens",

  /** The run generating the message was cancelled before completion. */
  runCancelled: "run_cancelled",

  /** The run generating the message failed. */
  runFailed: "run_failed",

  /** The run generating the message expired. */
  runExpired: "run_expired",
}

//
// These types are specifically used for streaming.
//

/** Represents a message delta i.e. any changed fields on a message during streaming. */
@added(Versions.v2025_05_01)
model MessageDeltaChunk {
  /** The identifier of the message, which can be referenced in API endpoints. */
  id: string;

  /** The object type, which is always `thread.message.delta`. */
  object: "thread.message.delta";

  /** The delta containing the fields that have changed on the Message. */
  delta: MessageDelta;
}

/** Represents the typed 'delta' payload within a streaming message delta chunk. */
@added(Versions.v2025_05_01)
model MessageDelta {
  /** The entity that produced the message. */
  role: MessageRole;

  /** The content of the message as an array of text and/or images. */
  content: MessageDeltaContent[];
}

/** The abstract base representation of a partial streamed message content payload. */
@discriminator("type")
@added(Versions.v2025_05_01)
model MessageDeltaContent {
  /** The index of the content part of the message. */
  index: int32;

  /** The type of content for this content part. */
  #suppress "@azure-tools/typespec-azure-core/no-string-discriminator" "Existing"
  type: string;
}

/** Represents a streamed image file content part within a streaming message delta chunk. */
@added(Versions.v2025_05_01)
model MessageDeltaImageFileContent extends MessageDeltaContent {
  /** The type of content for this content part, which is always "image_file." */
  type: "image_file";

  /** The image_file data. */
  @encodedName("application/json", "image_file")
  imageFile?: MessageDeltaImageFileContentObject;
}

/** Represents the 'image_file' payload within streaming image file content. */
@added(Versions.v2025_05_01)
model MessageDeltaImageFileContentObject {
  /** The file ID of the image in the message content. */
  @encodedName("application/json", "file_id")
  fileId?: string;
}

/** Represents a streamed text content part within a streaming message delta chunk. */
@added(Versions.v2025_05_01)
model MessageDeltaTextContent extends MessageDeltaContent {
  /** The type of content for this content part, which is always "text." */
  type: "text";

  /** The text content details. */
  text?: MessageDeltaTextContentObject;
}

/** Represents the data of a streamed text content part within a streaming message delta chunk. */
@added(Versions.v2025_05_01)
model MessageDeltaTextContentObject {
  /** The data that makes up the text. */
  value?: string;

  /** Annotations for the text. */
  annotations?: MessageDeltaTextAnnotation[];
}

/** The abstract base representation of a streamed text content part's text annotation. */
@discriminator("type")
@added(Versions.v2025_05_01)
model MessageDeltaTextAnnotation {
  /** The index of the annotation within a text content part. */
  index: int32;

  /** The type of the text content annotation. */
  #suppress "@azure-tools/typespec-azure-core/no-string-discriminator" "Existing"
  type: string;
}

@doc("A citation within the message that points to a specific URL associated with the message. Generated when the agent uses tools such as 'bing_grounding' to search the Internet.")
@added(Versions.v2025_05_01)
model MessageDeltaTextUrlCitationAnnotation extends MessageDeltaTextAnnotation {
  @doc("The object type, which is always 'url_citation'.")
  type: "url_citation";

  @encodedName("application/json", "url_citation")
  @doc("The details of the URL citation.")
  urlCitation: MessageDeltaTextUrlCitationDetails;

  @encodedName("application/json", "start_index")
  @doc("The first text index associated with this text annotation.")
  startIndex?: int32;

  @encodedName("application/json", "end_index")
  @doc("The last text index associated with this text annotation.")
  endIndex?: int32;
}

@doc("A representation of a URL citation, as used in text thread message content.")
@added(Versions.v2025_05_01)
model MessageDeltaTextUrlCitationDetails {
  @doc("The URL associated with this citation.")
  url: string;

  @doc("The title of the URL.")
  title?: string;
}

/** Represents a streamed file citation applied to a streaming text content part. */
@added(Versions.v2025_05_01)
model MessageDeltaTextFileCitationAnnotation
  extends MessageDeltaTextAnnotation {
  /** The type of the text content annotation, which is always "file_citation." */
  type: "file_citation";

  /** The file citation information. */
  @encodedName("application/json", "file_citation")
  fileCitation?: MessageDeltaTextFileCitationAnnotationObject;

  /** The text in the message content that needs to be replaced */
  text?: string;

  /** The start index of this annotation in the content text. */
  @encodedName("application/json", "start_index")
  startIndex?: int32;

  /** The end index of this annotation in the content text. */
  @encodedName("application/json", "end_index")
  endIndex?: int32;
}

/** Represents the data of a streamed file citation as applied to a streaming text content part. */
@added(Versions.v2025_05_01)
model MessageDeltaTextFileCitationAnnotationObject {
  /** The ID of the specific file the citation is from. */
  @encodedName("application/json", "file_id")
  fileId?: string;

  /** The specific quote in the cited file. */
  quote?: string;
}

/** Represents a streamed file path annotation applied to a streaming text content part. */
@added(Versions.v2025_05_01)
model MessageDeltaTextFilePathAnnotation extends MessageDeltaTextAnnotation {
  /** The type of the text content annotation, which is always "file_path." */
  type: "file_path";

  /** The file path information. */
  @encodedName("application/json", "file_path")
  filePath?: MessageDeltaTextFilePathAnnotationObject;

  /** The start index of this annotation in the content text. */
  @encodedName("application/json", "start_index")
  startIndex?: int32;

  /** The end index of this annotation in the content text. */
  @encodedName("application/json", "end_index")
  endIndex?: int32;

  /** The text in the message content that needs to be replaced */
  text?: string;
}

/** Represents the data of a streamed file path annotation as applied to a streaming text content part. */
@added(Versions.v2025_05_01)
model MessageDeltaTextFilePathAnnotationObject {
  /** The file ID for the annotation. */
  @encodedName("application/json", "file_id")
  fileId?: string;
}
